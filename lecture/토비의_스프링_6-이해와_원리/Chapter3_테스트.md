# 3. í…ŒìŠ¤íŠ¸

## ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” í…ŒìŠ¤íŠ¸

---

- í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì§€ ì•Šì„ ê±°ë©´ ìŠ¤í”„ë§ì„ ë„ëŒ€ì²´ ë­í•˜ëŸ¬ ì“°ëŠ” ê±°ì£ ?
- ìˆ˜ë™ í…ŒìŠ¤íŠ¸ì˜ í•œê³„
    1. í”„ë¦°íŠ¸ëœ ë©”ì‹œì§€ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ë°©ë²•ì€ ë¶ˆí¸í•˜ë‹¤
    2. ì‚¬ìš©ì ì›¹ UIê¹Œì§€ ê°œë°œí•œ ë’¤ì— í™•ì¸í•˜ëŠ” ë°©ë²•ì€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ í™•ì¸í•  ì½”ë“œê°€ ë§ë‹¤
    3. í…ŒìŠ¤íŠ¸í•  ëŒ€ìƒì´ ë§ì•„ì§ˆ ìˆ˜ë¡ ê²€ì¦í•˜ëŠ”ë° ì‹œê°„ì´ ë§ì´ ê±¸ë¦¬ê³  ë¶€ì •í™•í•¨

- ìˆ˜ë™ìœ¼ë¡œ ê°œë°œí•œ ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì€ ë²ˆê±°ë¡­ê³  í™œìš©í•˜ëŠ”ë° í•œê³„ê°€ ìˆë‹¤.
- ì½”ë“œë¡œ ë§Œë“¤ì–´ì ¸ ì–¸ì œë“  ì‹¤í–‰í•´ì„œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•˜ë‹¤. ì´ë¥¼ í†µí•´ì„œ ì§€ì†ì ì¸ ê°œì„ ê³¼ ì ì§„ì ì¸ ê°œë°œì´ ê°€ëŠ¥í•´ì§„ë‹¤.

- ê°œë°œìê°€ ë§Œë“œëŠ” í…ŒìŠ¤íŠ¸
    - í…ŒìŠ¤íŠ¸ë¥¼ ì½”ë“œë¡œ ë§Œë“¤ê³  ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì„œ ì‘ì„±í•œ ì½”ë“œì— ëŒ€í•œ í”¼ë“œë°±ì„ ë°›ëŠ”ë‹¤
    - í…ŒìŠ¤íŠ¸ ì‘ì„±ê³¼ ì‹¤í–‰ì´ ê°œë°œì„ í•˜ëŠ” ê³¼ì •ì˜ ì¼ë¶€ê°€ ëœë‹¤
    - í…ŒìŠ¤íŒ… í”„ë ˆì„ì›Œí¬ë¥¼ ì´ìš©í•´ì„œ í…ŒìŠ¤íŠ¸ ì‘ì„±ê³¼ ì‹¤í–‰ ê³¼ì •ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆë‹¤

## JUnit í…ŒìŠ¤íŠ¸ ì‘ì„±

---

- JUnitì€ ì¼„íŠ¸ ë²¡ê³¼ ì—ë¦­ ê°ë§ˆê°€ ì²˜ìŒ ê°œë°œí•œ ê°€ì¥ ëŒ€í‘œì ì¸ ìë™í™”ëœ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ ë„êµ¬ì´ë‹¤. ìë°” ì™¸ì˜ ë‹¤ë¥¸ ì–¸ì–´ë¡œë„ ìœ ì‚¬í•˜ê²Œ ê°œë°œë˜ì–´ì§€ë©´ì„œ ì´ë¥¼ í†µí‹€ì–´ xUnitì´ë¼ê³  ë¶€ë¥´ê¸°ë„ í•œë‹¤.

- JUnit5
    - [https://junit.org/junit5/](https://junit.org/junit5/), [https://junit.org/junit5/docs/current/user-guide](https://junit.org/junit5/docs/current/user-guide)
    - ìµœì‹  JUnit ë²„ì „ì´ë©° í˜„ì¬ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ ìì²´ì˜ í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©ë˜ê³ , ìŠ¤í”„ë§ì„ ì´ìš©í•´ì„œ ê°œë°œí•˜ëŠ” í”„ë¡œì íŠ¸ì—ì„œë„ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœë‹¤.

- í…ŒìŠ¤íŠ¸ ë©”ì†Œë“œì—” ì¤€ë¹„, ì‹¤í–‰, ê²€ì¦ ë‹¨ê³„ê°€ ìˆë‹¤.
    - ë©”ì†Œë“œëª…ì„ sortTest í•˜ì§€ë§ê³ , sort ë©”ì†Œë“œëª…ì— `@Test` ì–´ë…¸í…Œì´ì…˜ì„ ë‹¬ì•„ì¤€ë‹¤.

- ex> SortTest.java
    - Sort.java
        
        ```java
        package tobyspring.hellospring;
        
        import java.util.Arrays;
        import java.util.Collections;
        import java.util.List;
        
        public class Sort {
            public List<String> sortByLength(List<String> list) {
                list.sort((o1, o2) -> o1.length() - o2.length());
                return list;
            }
        
            public static void main(String[] args) {
                List<String> scores = Arrays.asList("z", "x", "spring", "java");
                Collections.sort(scores);
        
                scores.forEach(System.out::println);
            }
        }
        ```
        
    - `@Test` í…ŒìŠ¤íŠ¸ ë©”ì†Œë“œ
    - `@BeforeEach` í…ŒìŠ¤íŠ¸
        - ê° í…ŒìŠ¤íŠ¸ ì „ì— ì‹¤í–‰ëœë‹¤
        - í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ê°€ ë§Œë“¤ì–´ì§„ë‹¤.
    
    ```java
    package tobyspring.hellospring;
    
    import org.assertj.core.api.Assertions;
    import org.junit.jupiter.api.BeforeEach;
    import org.junit.jupiter.api.Test;
    
    import java.util.Arrays;
    import java.util.List;
    
    class SortTest {
        Sort sort;
    
        @BeforeEach
        void setUp() {
            sort = new Sort();
        }
    
        @Test
        void sort() {
            // ì¤€ë¹„ (given)
    
            // ì‹¤í–‰ (when)
            List<String> list = sort.sortByLength(Arrays.asList("aa", "b"));
    
            // ê²€ì¦ (then)
            Assertions.assertThat(list).isEqualTo(Arrays.asList("b", "aa"));
        }
    
        @Test
        void sort3Items() {
            List<String> list = sort.sortByLength(Arrays.asList("aa", "ccc", "b"));
    
            Assertions.assertThat(list).isEqualTo(Arrays.asList("b", "aa", "ccc"));
        }
    
        @Test
        void sortAlreadySorted() {
            List<String> list = sort.sortByLength(Arrays.asList("b", "aa", "ccc"));
    
            Assertions.assertThat(list).isEqualTo(Arrays.asList("b", "aa", "ccc"));
        }
    }
    ```
    

## PaymentService í…ŒìŠ¤íŠ¸

---

- ìë™í™”ëœ í…ŒìŠ¤íŠ¸ëŠ” ì–¸ì œë“  ì‹¤í–‰í•  ìˆ˜ ìˆê³  í•­ìƒ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì–»ì–´ì•¼ í•œë‹¤.
    - ë•Œë¡œëŠ” ì™¸ë¶€ ì‹œìŠ¤í…œì— ëŒ€í•œ í…ŒìŠ¤íŠ¸, í˜„ì¬ ì‹œê°„ê³¼ ê°™ì´ ì½”ë“œì—ì„œ ì‰½ê²Œ ì œì–´í•  ìˆ˜ ì—†ëŠ” ê°’ì„ ì´ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì•¼ í•˜ëŠ”ë° ì´ëŸ° ê²½ìš°ì— ì¼ê´€ëœ ê²°ê³¼ë¥¼ ë³´ì¥í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸°ê°€ ì‰½ì§€ ì•Šë‹¤.

- ì‹¤ìŠµ
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.junit.jupiter.api.DisplayName;
    import org.junit.jupiter.api.Test;
    import tobyspring.hellospring.exrate.WebApiExRateProvider;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    import java.time.LocalDateTime;
    
    import static org.assertj.core.api.Assertions.assertThat;
    
    class PaymentServiceTest {
    
        @Test
        @DisplayName("prepare")
        void prepare() throws IOException {
            PaymentService paymentService = new PaymentService(new WebApiExRateProvider());
    
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤
            assertThat(payment.getExRate()).isNotNull();
    
            // ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getConvertedAmount())
                    .isEqualTo(payment.getExRate().multiply(payment.getForeignCurrencyAmount()));
    
            // ì›í™”í™˜ì‚°ê¸ˆì•¡ì˜ ìœ íš¨ì‹œê°„ ê³„ì‚°
            assertThat(payment.getValidUntil()).isAfter(LocalDateTime.now());
            assertThat(payment.getValidUntil()).isAfter(LocalDateTime.now().plusMinutes(30));
    
        }
    }
    ```
    

## í…ŒìŠ¤íŠ¸ì˜ êµ¬ì„± ìš”ì†Œ

---

- PaymentService í…ŒìŠ¤íŠ¸ì˜ ë¬¸ì œì 
    1. ìš°ë¦¬ê°€ ì œì–´í•  ìˆ˜ ì—†ëŠ” ì™¸ë¶€ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ìƒê¸°ë©´?
    2. ExRateProviderê°€ ì œê³µí•˜ëŠ” í™˜ìœ¨ ê°’ìœ¼ë¡œ ê³„ì‚°í•œ ê²ƒì¸ê°€?
    3. í™˜ìœ¨ ìœ íš¨ì‹œê°„ ê³„ì‚°ì€ ì •í™•í•œ ê²ƒì¸ê°€?

![image.png](./image/3/image.png)

- ì˜í–¥ì„ ë¯¸ì¹ ë§Œí•œ ì œ3ì˜ ì˜¤ë¸Œì íŠ¸(í˜‘ë ¥ì)ëŠ” stubì„ ë§Œë“¤ì–´ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
    
    ![image.png](./image/3/image%201.png)
    

## í…ŒìŠ¤íŠ¸ì™€ DI (1)

---

- Stubì„ ì‚¬ìš©í•œ PaymentServiceTest.java
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.junit.jupiter.api.DisplayName;
    import org.junit.jupiter.api.Test;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    
    import static java.math.BigDecimal.valueOf;
    import static org.assertj.core.api.Assertions.assertThat;
    
    class PaymentServiceTest {
    
        @Test
        @DisplayName("prepare")
        void prepare() throws IOException {
            testAmout(valueOf(500), valueOf(5_000));
            testAmout(valueOf(1_000), valueOf(10_000));
            testAmout(valueOf(3_000), valueOf(30_000));
    
            // ì›í™”í™˜ì‚°ê¸ˆì•¡ì˜ ìœ íš¨ì‹œê°„ ê³„ì‚°
    //        assertThat(payment.getValidUntil()).isAfter(LocalDateTime.now());
    //        assertThat(payment.getValidUntil()).isBefore(LocalDateTime.now().plusMinutes(30));
    
        }
    
        private void testAmout(BigDecimal exRate, BigDecimal convertedAmount) throws IOException {
            PaymentService paymentService = new PaymentService(new ExRateProviderStub(exRate));
    
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤
            // ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getExRate()).isEqualByComparingTo(exRate);
            assertThat(payment.getConvertedAmount()).isEqualByComparingTo(convertedAmount);
        }
    }
    ```
    
    - `isEqualByComparingTo`: `BigDecimal`ì˜ ìë¦¿ìˆ˜ê¹Œì§€ ì²´í¬í•œë‹¤.

- í…ŒìŠ¤íŠ¸ ëŒ€ì—­(Test Double, Imposter), ìŠ¤í…(Stub), ëª©(Mock)
    - [https://martinfowler.com/bliki/TestDouble.html](https://martinfowler.com/bliki/TestDouble.html)
    - [https://martinfowler.com/articles/mocksArentStubs.html](https://martinfowler.com/articles/mocksArentStubs.html)

### ìŠ¤í”„ë§ DIë¥¼ ì´ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸

---

- ìˆ˜ë™ DIë¥¼ ì´ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ â†’ ì´ê±¸ë¡œ ê°€ëŠ¥í•˜ë©´ ì´ê±¸ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ êµ¬ì„±í•œë‹¤.
    - í…ŒìŠ¤íŠ¸ìš© í˜‘ë ¥ì(Collaborator)/ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì— ì§ì ‘ ì£¼ì…í•˜ê³  í…ŒìŠ¤íŠ¸
- ìŠ¤í”„ë§ DIë¥¼ ì´ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ â†’ ì˜ì¡´ê´€ê³„ê°€ ë§ì´ ì—®ì—¬ìˆëŠ” ê²½ìš°ì— ì‚¬ìš©í•œë‹¤.
    - í…ŒìŠ¤íŠ¸ìš© í˜‘ë ¥ì(Collaborator)/ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ìŠ¤í”„ë§ì˜ êµ¬ì„± ì •ë³´ë¥¼ ì´ìš©í•´ì„œ ì§€ì •í•˜ê³  ì»¨í…Œì´ë„ˆë¡œë¶€í„° í…ŒìŠ¤íŠ¸ ëŒ€ìƒì„ ê°€ì ¸ì™€ì„œ í…ŒìŠ¤íŠ¸
    - `@ContextConfiguration` + `@Autowired`

### ì‹¤ìŠµ

---

- TestObjectFactory.java
    
    ```java
    package tobyspring.hellospring;
    
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import tobyspring.hellospring.payment.ExRateProvider;
    import tobyspring.hellospring.payment.ExRateProviderStub;
    import tobyspring.hellospring.payment.PaymentService;
    
    import java.math.BigDecimal;
    
    @Configuration
    public class TestObjectFactory {
        @Bean
        public PaymentService paymentService() {
            return new PaymentService(exRateProvider());
        }
    
        @Bean
        public ExRateProvider exRateProvider() {
            return new ExRateProviderStub(BigDecimal.valueOf(1_000));
        }
    }
    ```
    
- PaymentServiceSpringTest.java
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.junit.jupiter.api.Test;
    import org.springframework.beans.factory.BeanFactory;
    import org.springframework.context.annotation.AnnotationConfigApplicationContext;
    import tobyspring.hellospring.TestObjectFactory;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    
    import static java.math.BigDecimal.valueOf;
    import static org.assertj.core.api.Assertions.assertThat;
    
    class PaymentServiceSpringTest {
    
        @Test
        void convertedAmount() throws IOException {
            BeanFactory beanFactory = new AnnotationConfigApplicationContext(TestObjectFactory.class);
            PaymentService paymentService = beanFactory.getBean(PaymentService.class);
    
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤ & ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getExRate()).isEqualByComparingTo(valueOf(1_000));
            assertThat(payment.getConvertedAmount()).isEqualByComparingTo(valueOf(10_000));
        }
    }
    ```
    

## í…ŒìŠ¤íŠ¸ì™€ DI (2)

---

- BeanFactoryì—ì„œ ì§ì ‘ êº¼ë‚´ì§€ ì•Šê³  `@ContextConfiguration` + `@Autowired` ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.junit.jupiter.api.Test;
    import org.junit.jupiter.api.extension.ExtendWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.test.context.ContextConfiguration;
    import org.springframework.test.context.junit.jupiter.SpringExtension;
    import tobyspring.hellospring.TestObjectFactory;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    
    import static java.math.BigDecimal.valueOf;
    import static org.assertj.core.api.Assertions.assertThat;
    
    @ExtendWith(SpringExtension.class)
    @ContextConfiguration(classes = TestObjectFactory.class)
    class PaymentServiceSpringTest {
    
        @Autowired
        PaymentService paymentService;
    
        @Test
        void convertedAmount() throws IOException {
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤ & ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getExRate()).isEqualByComparingTo(valueOf(1_000));
            assertThat(payment.getConvertedAmount()).isEqualByComparingTo(valueOf(10_000));
        }
    }
    ```
    
    - `@ExtendWith`: ìŠ¤í”„ë§ì„ ì´ìš©í•´ì„œ í™•ì¥í•´ë‹¬ë¼ëŠ” ì˜ë¯¸

ğŸ‘‰

- ë§Œë“¤ì–´ë†“ì€ Stubì„ ì£¼ì…ë°›ìœ¼ë©´ í…ŒìŠ¤íŠ¸ì½”ë“œ ë‚´ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.junit.jupiter.api.Test;
    import org.junit.jupiter.api.extension.ExtendWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.test.context.ContextConfiguration;
    import org.springframework.test.context.junit.jupiter.SpringExtension;
    import tobyspring.hellospring.TestObjectFactory;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    
    import static java.math.BigDecimal.valueOf;
    import static org.assertj.core.api.Assertions.assertThat;
    
    @ExtendWith(SpringExtension.class)
    @ContextConfiguration(classes = TestObjectFactory.class)
    class PaymentServiceSpringTest {
    
        @Autowired
        PaymentService paymentService;
        @Autowired ExRateProviderStub exRateProviderStub;
    
        @Test
        void convertedAmount() throws IOException {
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤ & ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getExRate()).isEqualByComparingTo(valueOf(1_000));
            assertThat(payment.getConvertedAmount()).isEqualByComparingTo(valueOf(10_000));
    
            // exRate: 500
            exRateProviderStub.setExRate(valueOf(500));
            Payment payment2 = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            assertThat(payment2.getExRate()).isEqualByComparingTo(valueOf(500));
            assertThat(payment2.getConvertedAmount()).isEqualByComparingTo(valueOf(5_000));
    
        }
    }
    ```
    

- ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ êµ¬ì„±í•˜ê³  ì—¬ê¸°ì„œ í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ëŒ€ìƒê³¼ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ í…ŒìŠ¤íŠ¸ì—ì„œ ì°¸ê³ í•  ë¹ˆ ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì ¸ì˜¤ê²Œ í•  ìˆ˜ ìˆë‹¤.
- ìŠ¤í”„ë§ì€ ë°©ëŒ€í•œ ì–‘ì˜ í…ŒìŠ¤íŒ… ì§€ì› ê¸°ìˆ ì„ ì œê³µí•œë‹¤.([ë¬¸ì„œ](https://docs.spring.io/spring-framework/reference/testing.html))
- JUnitì—ì„œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ë•Œ `@ExtendWith`ì™€ `@ContextConfiguration`ë¥¼ ì´ìš©í•œë‹¤.
    - `@ExtendWith`: JUnit 5 í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ê°€ ìŠ¤í”„ë§ í…ŒìŠ¤íŒ… ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë„ë¡ ì§€ì •í•œë‹¤
        - ì•„ë˜ `@ContextConfiguration`ê³¼ ê²°í•©í•œ í•©ì„± ì• ë…¸í…Œì´ì…˜ì¸ `@SpringJUnitConfig`ë¥¼ ì´ìš©í•  ìˆ˜ë„ ìˆë‹¤.([ë¬¸ì„œ](https://docs.spring.io/spring-framework/reference/testing/annotations/integration-junit-jupiter.html#integration-testing-annotations-junit-jupiter-springjunitconfig))
    - `@ContextConfiguration`([ë¬¸ì„œ](https://docs.spring.io/spring-framework/reference/testing/annotations/integration-spring/annotation-contextconfiguration.html#page-title))
    - `@Autowired`: í…ŒìŠ¤íŠ¸ ì½”ë“œì— `@Autowired`ê°€ ë¶™ì€ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•˜ë©° ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ì— ì˜í•´ì„œ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì˜ íƒ€ì…ê³¼ ì¼ì¹˜í•˜ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ ë¹ˆ ì˜¤ë¸Œì íŠ¸ë¥¼ ì£¼ì…í•´ì¤€ë‹¤.
        - `@Autowired` ì™¸ì—ë„ ìŠ¤í”„ë§ì—ì„œ ì§€ì›í•˜ëŠ” ì—¬ëŸ¬ê°€ì§€ ì¢…ë¥˜ì˜ ì• ë…¸í…Œì´ì…˜ì„ ì§€ì›í•œë‹¤.([ë¬¸ì„œ](https://docs.spring.io/spring-framework/reference/testing/annotations/integration-standard.html#page-title))

## í•™ìŠµ í…ŒìŠ¤íŠ¸

---

- ì¼„íŠ¸ ë²¡ì˜ í…ŒìŠ¤íŠ¸ì£¼ë„ê°œë°œ, ë¡œë²„íŠ¸ ë§ˆí‹´ì˜ í´ë¦° ì½”ë“œ ì—ì„œ ì†Œê°œëœ í…ŒìŠ¤íŠ¸ ë°©ë²•ì˜ í•œ ê°€ì§€ì´ë‹¤.
- í•™ìŠµ í…ŒìŠ¤íŠ¸: ë‚´ê°€ ë§Œë“¤ì§€ ì•Šì€ ì½”ë“œ, ë¼ì´ë¸ŒëŸ¬ë¦¬, API, ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë“±ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ì´ë‹¤.
    - ëª©ì : ì‚¬ìš©í•  APIë‚˜ í”„ë ˆì„ì›Œí¬ì˜ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸ë¡œ ì‘ì„±í•˜ê³  ì‹¤í–‰í•´ë³´ë©´ì„œ ì‚¬ìš©ë°©ë²•ì„ ë°”ë¥´ê²Œ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
    - í…ŒìŠ¤íŠ¸ ëŒ€ìƒì˜ ì‚¬ìš©ë°©ë²•ì„ ìµíˆê³  ë™ì‘ë°©ì‹ì„ í™•ì¸í•˜ëŠ”ë° ìœ ìš©í•˜ë‹¤.
    - ì™¸ë¶€ ê¸°ìˆ , ì„œë¹„ìŠ¤ê°€ ë²„ì „ì´ ì˜¬ë¼ê°”ì„ ë•Œ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ë„ ìˆë‹¤.

- `assertj`ì˜ `Assertions` ë¼ì´ë¸Œí…œí”Œë¦¿ ë“±ë¡í•˜ê¸°
    
    ![image.png](./image/3/image%202.png)
    

- ClockTest.java (`java.time.Clock`)
    
    ```java
    package tobyspring.hellospring.learningtest;
    
    import org.assertj.core.api.Assertions;
    import org.junit.jupiter.api.Test;
    
    import java.time.Clock;
    import java.time.Instant;
    import java.time.LocalDateTime;
    import java.time.ZoneId;
    
    public class ClockTest {
        // Clockì„ ì´ìš©í•´ì„œ LocalDateTime.now?
        @Test
        void clock() {
            Clock clock = Clock.systemDefaultZone();
    
            LocalDateTime dt1 = LocalDateTime.now(clock);
            LocalDateTime dt2 = LocalDateTime.now(clock);
    
            Assertions.assertThat(dt2).isAfter(dt1);
        }
    
        // Clockì„ Testì—ì„œ ì‚¬ìš©í•  ë•Œ ë‚´ê°€ ì›í•˜ëŠ” ì‹œê°„ì„ ì§€ì •í•´ì„œ í˜„ì¬ ì‹œê°„ì„ ê°€ì ¸ì˜¤ê²Œ í•  ìˆ˜ ìˆëŠ”ê°€?
        @Test
        void fixedClock() {
            Clock clock = Clock.fixed(Instant.now(), ZoneId.systemDefault());
    
            LocalDateTime dt1 = LocalDateTime.now(clock);
            LocalDateTime dt2 = LocalDateTime.now(clock);
    
            LocalDateTime dt3 = LocalDateTime.now(clock).plusHours(1);
    
            Assertions.assertThat(dt2).isEqualTo(dt1);
            Assertions.assertThat(dt3).isEqualTo(dt1.plusHours(1));
        }
    }
    ```
    

## Clockì„ ì´ìš©í•œ ì‹œê°„ í…ŒìŠ¤íŠ¸

---

![image.png](./image/3/image%203.png)

â†’

![image.png](./image/3/image%204.png)

- ObjectFactory â†’ PaymentConfig ë¡œ ë„¤ì´ë° ë³€ê²½, Clock bean ì¶”ê°€
    - PaymentConfig: `Clock.systemDefaultZone()`
    - TestPaymentConfig: `Clock.fixed(Instant.now(), ZoneId.systemDefault())`

### ì‹¤ìŠµ

---

- PaymentService.java
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.springframework.stereotype.Component;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    import java.time.Clock;
    import java.time.LocalDateTime;
    
    @Component
    public class PaymentService {
        private final ExRateProvider exRateProvider;
        private final Clock clock;
    
        public PaymentService(ExRateProvider exRateProvider, Clock clock) {
            this.exRateProvider = exRateProvider;
            this.clock = clock;
        }
    
        public Payment prepare(Long orderId, String currency, BigDecimal foreignCurrencyAmount) throws IOException {
            BigDecimal exRate = exRateProvider.getExRate(currency);
            BigDecimal convertedAmount = foreignCurrencyAmount.multiply(exRate);
            LocalDateTime validUntil = LocalDateTime.now(clock).plusMinutes(30);
    
            return new Payment(orderId, currency, foreignCurrencyAmount, exRate, convertedAmount, validUntil);
        }
    }
    ```
    
- PaymentServiceTest.java
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.assertj.core.api.Assertions;
    import org.junit.jupiter.api.BeforeEach;
    import org.junit.jupiter.api.DisplayName;
    import org.junit.jupiter.api.Test;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    import java.time.Clock;
    import java.time.Instant;
    import java.time.LocalDateTime;
    import java.time.ZoneId;
    
    import static java.math.BigDecimal.valueOf;
    import static org.assertj.core.api.Assertions.assertThat;
    
    class PaymentServiceTest {
        Clock clock;
    
        @BeforeEach
        void beforeEach() {
            this.clock = Clock.fixed(Instant.now(), ZoneId.systemDefault());
        }
    
        @Test
        void convertAmount() throws IOException {
            testAmout(valueOf(500), valueOf(5_000), this.clock);
            testAmout(valueOf(1_000), valueOf(10_000), this.clock);
            testAmout(valueOf(3_000), valueOf(30_000), this.clock);
        }
    
        @Test
        void validUntil() throws IOException {
            PaymentService paymentService = new PaymentService(new ExRateProviderStub(valueOf(1_000)), clock);
    
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // valid untilì´ prepare() 30ë¶„ ë’¤ë¡œ ì„¤ì •ëëŠ”ê°€?
            LocalDateTime now = LocalDateTime.now(this.clock);
            LocalDateTime expectedValidUntil = now.plusMinutes(30);
    
            Assertions.assertThat(payment.getValidUntil()).isEqualTo(expectedValidUntil);
        }
    
        private void testAmout(BigDecimal exRate, BigDecimal convertedAmount, Clock clock) throws IOException {
            PaymentService paymentService = new PaymentService(new ExRateProviderStub(exRate), clock);
    
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤
            // ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getExRate()).isEqualByComparingTo(exRate);
            assertThat(payment.getConvertedAmount()).isEqualByComparingTo(convertedAmount);
        }
    }
    
    ```
    
- PaymentServiceSpringTest.java
    
    ```java
    package tobyspring.hellospring.payment;
    
    import org.assertj.core.api.Assertions;
    import org.junit.jupiter.api.Test;
    import org.junit.jupiter.api.extension.ExtendWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.test.context.ContextConfiguration;
    import org.springframework.test.context.junit.jupiter.SpringExtension;
    import tobyspring.hellospring.TestPaymentConfig;
    
    import java.io.IOException;
    import java.math.BigDecimal;
    import java.time.Clock;
    import java.time.LocalDateTime;
    
    import static java.math.BigDecimal.valueOf;
    import static org.assertj.core.api.Assertions.assertThat;
    
    @ExtendWith(SpringExtension.class)
    @ContextConfiguration(classes = TestPaymentConfig.class)
    class PaymentServiceSpringTest {
    
        @Autowired
        PaymentService paymentService;
        @Autowired
        Clock clock;
        @Autowired
        ExRateProviderStub exRateProviderStub;
    
        @Test
        void convertedAmount() throws IOException {
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤ & ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment.getExRate()).isEqualByComparingTo(valueOf(1_000));
            assertThat(payment.getConvertedAmount()).isEqualByComparingTo(valueOf(10_000));
    
            // exRate: 500
            exRateProviderStub.setExRate(valueOf(500));
            Payment payment2 = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // í™˜ìœ¨ì •ë³´ ê°€ì ¸ì˜¨ë‹¤ & ì›í™”í™˜ì‚°ê¸ˆì•¡ ê³„ì‚°
            assertThat(payment2.getExRate()).isEqualByComparingTo(valueOf(500));
            assertThat(payment2.getConvertedAmount()).isEqualByComparingTo(valueOf(5_000));
        }
    
        @Test
        void validUntil() throws IOException {
            PaymentService paymentService = new PaymentService(new ExRateProviderStub(valueOf(1_000)), clock);
    
            Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);
    
            // valid untilì´ prepare() 30ë¶„ ë’¤ë¡œ ì„¤ì •ëëŠ”ê°€?
            LocalDateTime now = LocalDateTime.now(this.clock);
            LocalDateTime expectedValidUntil = now.plusMinutes(30);
    
            Assertions.assertThat(payment.getValidUntil()).isEqualTo(expectedValidUntil);
        }
    }
    ```
    

## ë„ë©”ì¸ ì˜¤ë¸Œì íŠ¸ í…ŒìŠ¤íŠ¸

---

- í…ŒìŠ¤íŠ¸ì˜ ê½ƒ
- ë„ë©”ì¸ ëª¨ë¸ ì•„í‚¤í…ì²˜ íŒ¨í„´: ë„ë©”ì¸ ë¡œì§, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì–´ë””ì— ë‘˜ ì§€ë¥¼ ê²°ì •í•˜ëŠ” íŒ¨í„´
    1. íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ - ì„œë¹„ìŠ¤ ë©”ì†Œë“œ (PaymentService.prepare)
    2. ë„ë©”ì¸ ëª¨ë¸ - ë„ë©”ì¸ ëª¨ë¸ ì˜¤ë¸Œì íŠ¸ (Payment)

- `Payment`
    - AS-IS: Data Carrier
    - TO-BE: ë„ë©”ì¸ ëª¨ë¸
        - ìƒì„±ì ë§ê³  íŒ©í† ë¦¬ ë©”ì„œë“œ ì¶”ê°€, ìœ íš¨ì„± ê²€ì¦ë¡œì§ ì¶”ê°€
            
            ```java
            public static Payment createPrepared(Long orderId, String currency, BigDecimal foreignCurrencyAmount, BigDecimal exRate,
                                                 LocalDateTime now) {
                BigDecimal convertedAmount = foreignCurrencyAmount.multiply(exRate);
                LocalDateTime validUntil = now.plusMinutes(30);
            
                return new Payment(orderId, currency, foreignCurrencyAmount, exRate, convertedAmount, validUntil);
            }
            
            public boolean isValid(Clock clock) {
                return LocalDateTime.now(clock).isBefore(this.validUntil);
            }
            ```
            
        - PaymentTest.java
            
            ```java
            package tobyspring.hellospring.payment;
            
            import org.assertj.core.api.Assertions;
            import org.junit.jupiter.api.Test;
            
            import java.math.BigDecimal;
            import java.time.*;
            import java.time.temporal.ChronoUnit;
            
            public class PaymentTest {
                @Test
                void createPrepared() {
                    Clock clock = Clock.fixed(Instant.now(), ZoneId.systemDefault());
            
                    Payment payment = Payment.createPrepared(
                            1L, "USD", BigDecimal.TEN, BigDecimal.valueOf(1_000), LocalDateTime.now(clock));
            
                    Assertions.assertThat(payment.getConvertedAmount()).isEqualByComparingTo(BigDecimal.valueOf(10_000));
                    Assertions.assertThat(payment.getValidUntil()).isEqualTo(LocalDateTime.now(clock).plusMinutes(30));
                }
            
                @Test
                void isValid() {
                    Clock clock = Clock.fixed(Instant.now(), ZoneId.systemDefault());
            
                    Payment payment = Payment.createPrepared(
                            1L, "USD", BigDecimal.TEN, BigDecimal.valueOf(1_000), LocalDateTime.now(clock));
            
                    Assertions.assertThat(payment.isValid(clock)).isTrue();
                    Assertions.assertThat(payment.isValid(Clock.offset(clock, Duration.of(30, ChronoUnit.MINUTES)))).isFalse();
                }
            }
            ```
            

- ìŠ¤í”„ë§ê³¼ JDK ì—…ê·¸ë ˆì´ë“œ
    - ìŠ¤í”„ë§ 6.0 â†’ ìŠ¤í”„ë§ 6.1 (ìŠ¤í”„ë§ ë¶€íŠ¸ 3.2)
    - JDK 21
    - ìƒˆë¡œìš´ ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³  Gradle ì„¤ì •ì„ ì°¸ê³ í•´ì„œ ë³€ê²½

- ê°œë°œìê°€ ë§Œë“œëŠ” í…ŒìŠ¤íŠ¸
    - ê°œë°œí•œ ì½”ë“œì— ëŒ€í•œ ê²€ì¦ ê¸°ëŠ¥ì„ ì½”ë“œë¡œ ì‘ì„±í•œë‹¤
    - ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•œë‹¤
    - í…ŒìŠ¤íŒ… í”„ë ˆì„ì›Œí¬ë¥¼ í™œìš©í•œë‹¤
    - í…ŒìŠ¤íŠ¸ ì‘ì„±ê³¼ ì‹¤í–‰ë„ ê°œë°œ ê³¼ì •ì˜ ì¼ë¶€ì´ë‹¤

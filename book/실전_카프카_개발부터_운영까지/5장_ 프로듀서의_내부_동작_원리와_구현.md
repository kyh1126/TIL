# 5ì¥. í”„ë¡œë“€ì„œì˜ ë‚´ë¶€ ë™ì‘ ì›ë¦¬ì™€ êµ¬í˜„

- í”„ë¡œë“€ì„œê°€ ì „ì†¡í•˜ë ¤ëŠ” ë©”ì‹œì§€ë“¤ì€ í”„ë¡œë“€ì„œì˜ `send()` ë©”ì†Œë“œë¥¼ í†µí•´ ì‹œë¦¬ì–¼ë¼ì´ì €, íŒŒí‹°ì…”ë„ˆë¥¼ ê±°ì³ ì¹´í”„ì¹´ë¡œ ì „ì†¡ëœë‹¤.

## 1. íŒŒí‹°ì…”ë„ˆ

---

- ì¹´í”„ì¹´ì˜ í† í”½ì€ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ë³‘ë ¬ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ë‰˜ê³ , ìµœì†Œ í•˜ë‚˜ ë˜ëŠ” ë‘˜ ì´ìƒì˜ íŒŒí‹°ì…˜ìœ¼ë¡œ êµ¬ì„±ëœë‹¤.
- ì¹´í”„ì¹´ë¡œ ì „ì†¡í•œ ë©”ì‹œì§€ëŠ” í•´ë‹¹ í† í”½ ë‚´ ê° íŒŒí‹°ì…˜ì˜ ë¡œê·¸ ì„¸ê·¸ë¨¼íŠ¸ì— ì €ì¥ëœë‹¤.

- íŒŒí‹°ì…”ë„ˆ: í† í”½ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ í•´ë‹¹ í† í”½ì˜ ì–´ëŠ íŒŒí‹°ì…˜ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì•¼ í• ì§€ë¥¼ ê²°ì •
- íŒŒí‹°ì…˜ì„ ê²°ì •í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜: ë©”ì‹œì§€(ë ˆì½”ë“œ)ì˜ í‚¤ë¥¼ í•´ì‹œ(hash) ì²˜ë¦¬í•´ íŒŒí‹°ì…˜ì„ êµ¬í•˜ëŠ” ë°©ì‹
    - ë©”ì‹œì§€ì˜ í‚¤ê°’ì´ ë™ì¼í•˜ë©´ í•´ë‹¹ ë©”ì‹œì§€ë“¤ì€ ëª¨ë‘ ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡ëœë‹¤.

- í† í”½ì˜ íŒŒí‹°ì…˜ì„ ëŠ˜ë¦´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥
    - íŒŒí‹°ì…˜ ìˆ˜ê°€ ë³€ê²½ë¨ê³¼ ë™ì‹œì—, ë©”ì‹œì§€ì˜ í‚¤ì™€ ë§¤í•‘ëœ í•´ì‹œ í…Œì´ë¸”ë„ ë³€ê²½ëœë‹¤.
    - ë™ì¼í•œ ë©”ì‹œì§€ì˜ í‚¤ë¥¼ ì´ìš©í•´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ë”ë¼ë„ íŒŒí‹°ì…˜ì˜ ìˆ˜ë¥¼ ëŠ˜ë¦° í›„ì—ëŠ” ë‹¤ë¥¸ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡ë  ìˆ˜ ìˆë‹¤.

![5-1. íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€ì— ë”°ë¥¸ í•´ì‹œ ë³€ê²½ ë°©ì‹](./images/5/Untitled.png)

5-1. íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€ì— ë”°ë¥¸ í•´ì‹œ ë³€ê²½ ë°©ì‹

<aside>
ğŸ’¡ ë©”ì‹œì§€ì˜ í‚¤ë¥¼ ì´ìš©í•´ ì¹´í”„ì¹´ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ê²½ìš°, ê´€ë¦¬ìì˜ ì˜ë„ì™€ëŠ” ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ì´ ì´ë¤„ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë˜ë„ë¡ íŒŒí‹°ì…˜ ìˆ˜ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ê¶Œì¥

</aside>

### 1-1. ë¼ìš´ë“œ ë¡œë¹ˆ ì „ëµ

---

- í”„ë¡œë“€ì„œì˜ ë©”ì‹œì§€ ì¤‘ ë ˆì½”ë“œ(ë©”ì‹œì§€)ì˜ í‚¤ê°’ì€ í•„ìˆ«ê°’ì´ ì•„ë‹ˆë¯€ë¡œ, ê´€ë¦¬ìëŠ” ë³„ë„ì˜ ë ˆì½”ë“œ í‚¤ê°’ì„ ì§€ì •í•˜ì§€ ì•Šê³  ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆë‹¤.
- ë§Œì•½ í‚¤ê°’ì„ ì§€ì •í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ í‚¤ê°’ì€ `null`ì´ ë˜ê³ , ê¸°ë³¸ê°’ì¸ ë¼ìš´ë“œ ë¡œë¹ˆ(round-robin) ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•´ í”„ë¡œë“€ì„œëŠ” ëª©ì ì§€ í† í”½ì˜ íŒŒí‹°ì…˜ë“¤ë¡œ ë ˆì½”ë“œë“¤ì„ ëœë¤ ì „ì†¡í•œë‹¤.
- íŒŒí‹°ì…”ë„ˆë¥¼ ê±°ì¹œ í›„ì˜ ë ˆì½”ë“œë“¤ì€ ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ í”„ë¡œë“€ì„œì˜ ë²„í¼ ë©”ëª¨ë¦¬ ì˜ì—­ì—ì„œ ì ì‹œ ëŒ€ê¸°í•œ í›„ ì¹´í”„ì¹´ë¡œ ì „ì†¡ëœë‹¤.
    - ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì ì‹œ ë©”ì‹œì§€ë“¤ì´ ëŒ€ê¸°í•˜ëŠ” ê³¼ì •ì—ì„œ ë¼ìš´ë“œ ë¡œë¹ˆ ì „ëµì€ íš¨ìœ¨ì„ ë–¨ì–´ëœ¨ë¦´ ìˆ˜ ìˆë‹¤.
        
        ![5-2. í‚¤ê°’ì´ `null`ì¸ ë¼ìš´ë“œ ë¡œë¹ˆ ì „ëµ](./images/5/Untitled%201.png)
        
        5-2. í‚¤ê°’ì´ `null`ì¸ ë¼ìš´ë“œ ë¡œë¹ˆ ì „ëµ
        
        - ë ˆì½”ë“œê°€ íŒŒí‹°ì…”ë„ˆë¥¼ ê±°ì³ ì§€ë‚˜ê°”ì§€ë§Œ ì¹´í”„ì¹´ë¡œ ì „ì†¡ë˜ì§€ ëª»í•œ ì±„ í”„ë¡œë“€ì„œ ë‚´ì—ì„œ ëŒ€ê¸°
            
            â†’ íŒŒí‹°ì…˜ë³„ ìµœì†Œ ë ˆì½”ë“œ ìˆ˜ì˜ ê¸°ì¤€ì¸ 3ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆê¸° ë•Œë¬¸
            

### 1-2. ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹ ì „ëµ

---

- ë¼ìš´ë“œ ë¡œë¹ˆ ì „ëµì—ì„œ ì§€ì—°ì‹œê°„ì´ ë¶ˆí•„ìš”í•˜ê²Œ ì¦ê°€ë˜ëŠ” ë¹„íš¨ìœ¨ì ì¸ ì „ì†¡ì„ ê°œì„ í•˜ê³ ì 2019ë…„ ì¶œì‹œëœ ì•„íŒŒì¹˜ ì¹´í”„ì¹´ 2.4 ë²„ì „ë¶€í„°ëŠ” ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹ ì „ëµì„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.
- ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹: í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ì— ë ˆì½”ë“œ ìˆ˜ë¥¼ ë¨¼ì € ì±„ì›Œì„œ ì¹´í”„ì¹´ë¡œ ë¹ ë¥´ê²Œ ë°°ì¹˜ ì „ì†¡í•˜ëŠ” ì „ëµ
    
    ![5-3. ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹ ì „ëµ](./images/5/Untitled%202.png)
    
    5-3. ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹ ì „ëµ
    
- ì»¨í”Œë£¨ì–¸íŠ¸ì—ì„œ ê³µê°œí•œ [ë¸”ë¡œê·¸ ê¸€](https://www.confluent.io/blog/apache-kafka-producer-improvements-sticky-partitioner/)ì— ë”°ë¥´ë©´,Â ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹ ì „ëµì„ ì ìš©í•¨ìœ¼ë¡œì¨ ê¸°ë³¸ ì„¤ì •ì— ë¹„í•´ ì•½ 30% ì´ìƒ ì§€ì—°ì‹œê°„ì´ ê°ì†Œí•˜ê³  í”„ë¡œë“€ì„œì˜ CPU ì‚¬ìš©ë¥ ë„ ì¤„ì–´ë“œëŠ” íš¨ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.

<aside>
ğŸ’¡ ì¹´í”„ì¹´ë¡œ ì „ì†¡í•˜ëŠ” ë©”ì‹œì§€ì˜ ìˆœì„œê°€ ê·¸ë‹¤ì§€ ì¤‘ìš”í•˜ì§€ ì•Šì€ ê²½ìš°ë¼ë©´ ìŠ¤í‹°í‚¤ íŒŒí‹°ì…”ë‹ ì „ëµì„ ì ìš©í•˜ê¸°ë¥¼ ê¶Œì¥í•œë‹¤.

</aside>

## 2. í”„ë¡œë“€ì„œì˜ ë°°ì¹˜

---

- ì¹´í”„ì¹´ì—ì„œëŠ” í† í”½ì˜ ì²˜ë¦¬ëŸ‰ì„ ë†’ì´ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ í† í”½ì„ íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ëˆ  ì²˜ë¦¬í•˜ë©°, ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ì¸ í”„ë¡œë“€ì„œì—ì„œëŠ” ì²˜ë¦¬ëŸ‰ì„ ë†’ì´ê¸° ìœ„í•´ ë°°ì¹˜ ì „ì†¡ì„ ê¶Œì¥í•œë‹¤.
    
    ![5-4. í”„ë¡œë“€ì„œì˜ ë°°ì¹˜ êµ¬ì„±ë„](./images/5/Untitled%203.png)
    
    5-4. í”„ë¡œë“€ì„œì˜ ë°°ì¹˜ êµ¬ì„±ë„
    
- í”„ë¡œë“€ì„œëŠ” ë°°ì¹˜ ì „ì†¡ì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì˜µì…˜ë“¤ì„ ì œê³µí•œë‹¤.
    - `buffer.memory`
        - ì¹´í”„ì¹´ë¡œ ë©”ì‹œì§€ë“¤ì„ ì „ì†¡í•˜ê¸° ìœ„í•´ ë‹´ì•„ë‘ëŠ” í”„ë¡œë“€ì„œì˜ ë²„í¼ ë©”ëª¨ë¦¬ ì˜µì…˜ (ê¸°ë³¸ê°’: 32MB)
    - `batch.size`
        - ë°°ì¹˜ ì „ì†¡ì„ ìœ„í•´ ë©”ì‹œì§€(ë ˆì½”ë“œ)ë“¤ì„ ë¬¶ëŠ” ë‹¨ìœ„ë¥¼ ì„¤ì •í•˜ëŠ” ë°°ì¹˜ í¬ê¸° ì˜µì…˜ (ê¸°ë³¸ê°’: 16KB)
    - `linger.ms`
        - ë°°ì¹˜ ì „ì†¡ì„ ìœ„í•´ ë²„í¼ ë©”ëª¨ë¦¬ì—ì„œ ëŒ€ê¸°í•˜ëŠ” ë©”ì‹œì§€ë“¤ì˜ ìµœëŒ€ ëŒ€ê¸°ì‹œê°„ì„ ì„¤ì •í•˜ëŠ” ì˜µì…˜ (ê¸°ë³¸ê°’: 0ms)
        - ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´, ë°°ì¹˜ ì „ì†¡ì„ ìœ„í•´ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë©”ì‹œì§€ë“¤ì´ ì¦‰ì‹œ ì „ì†¡ëœë‹¤.

- ì¹´í”„ì¹´ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª©ì ì— ë”°ë¼ ì²˜ë¦¬ëŸ‰ì„ ë†’ì¼ì§€, ì•„ë‹ˆë©´ ì§€ì—° ì—†ëŠ” ì „ì†¡ì„ í•´ì•¼ í• ì§€ ì„ íƒì„ í•´ì•¼ í•œë‹¤.
- ì‚¬ìš©ìê°€ í”„ë¡œë“€ì„œì˜ ë†’ì€ ì²˜ë¦¬ëŸ‰ì„ ëª©í‘œë¡œ ë°°ì¹˜ ì „ì†¡ì„ ì„¤ì •í•˜ëŠ” ê²½ìš° ì£¼ì˜í•´ì•¼ í•  ì‚¬í•­ â†’ ë²„í¼ ë©”ëª¨ë¦¬ í¬ê¸°ê°€ ì¶©ë¶„íˆ ì»¤ì•¼ í•œë‹¤.
    - `buffer.meomry` í¬ê¸°ëŠ” ë°˜ë“œì‹œ `batch.size`ë³´ë‹¤ ì»¤ì•¼ í•œë‹¤.
- ì••ì¶• ê¸°ëŠ¥ì„ ê°™ì´ ì‚¬ìš©í•œë‹¤ë©´, í”„ë¡œë“€ì„œëŠ” ë©”ì‹œì§€ë“¤ì„ ë”ìš± íš¨ìœ¨ì ìœ¼ë¡œ ì¹´í”„ì¹´ë¡œ ì „ì†¡í•  ìˆ˜ ìˆë‹¤.
    - ë†’ì€ ì••ì¶•ë¥ ì„ ì„ í˜¸í•œë‹¤ë©´ `gzip`, `zstd`
    - ë‚®ì€ ì§€ì—°ì‹œê°„ì„ ì„ í˜¸í•œë‹¤ë©´ `lz4`, `snappy`

## 3. ì¤‘ë³µ ì—†ëŠ” ì „ì†¡

---

- ë©”ì‹œì§€ ì‹œìŠ¤í…œë“¤ì˜ ë©”ì‹œì§€ ì „ì†¡ ë°©ì‹
    - ì ì–´ë„ í•œ ë²ˆ ì „ì†¡(at-least-once) ğŸ‘‰Â ì¹´í”„ì¹´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì ì–´ë„ í•œ ë²ˆ ì „ì†¡ ë°©ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘
        
        ![5-5. ì ì–´ë„ í•œ ë²ˆ ì „ì†¡ ê³¼ì •](./images/5/Untitled%204.png)
        
        5-5. ì ì–´ë„ í•œ ë²ˆ ì „ì†¡ ê³¼ì •
        
        - í”„ë¡œë“€ì„œ ì…ì¥ì—ì„œëŠ” ë¸Œë¡œì»¤ê°€ ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³  ACKë§Œ ì „ì†¡í•˜ì§€ ëª»í•œ ê²ƒì¸ì§€, ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ì§€ ëª»í•´ì„œ ACKë¥¼ ì „ì†¡í•˜ì§€ ì•Šì€ ê²ƒì¸ì§€ëŠ” ì •í™•íˆ ì•Œ ìˆ˜ ì—†ë‹¤.
        - ë©”ì‹œì§€Bì— ëŒ€í•œ ACKë¥¼ ë°›ì§€ ëª»í•œ í”„ë¡œë“€ì„œëŠ” ì ì–´ë„ í•œ ë²ˆ ì „ì†¡ ë°©ì‹ì— ë”°ë¼ ë©”ì‹œì§€Bë¥¼ ë‹¤ì‹œ í•œë²ˆ ì „ì†¡
        - ë„¤íŠ¸ì›Œí¬ì˜ íšŒì„  ì¥ì• ë‚˜ ê¸°íƒ€ ì¥ì•  ìƒí™©ì— ë”°ë¼ ì¼ë¶€ ë©”ì‹œì§€ ì¤‘ë³µì´ ë°œìƒí•  ìˆ˜ëŠ” ìˆì§€ë§Œ, ìµœì†Œí•œ í•˜ë‚˜ì˜ ë©”ì‹œì§€ëŠ” ë°˜ë“œì‹œ ë³´ì¥í•œë‹¤ëŠ” ê²ƒì´ ì ì–´ë„ í•œ ë²ˆ ì „ì†¡ ë°©ì‹
    - ìµœëŒ€ í•œ ë²ˆ ì „ì†¡(at-most-once)
        
        ![5-6. ìµœëŒ€ í•œ ë²ˆ ì „ì†¡ ê³¼ì •](./images/5/Untitled%205.png)
        
        5-6. ìµœëŒ€ í•œ ë²ˆ ì „ì†¡ ê³¼ì •
        
        - ìµœëŒ€ í•œ ë²ˆ ì „ì†¡ì€ ACKë¥¼ ë°›ì§€ ëª»í•˜ë”ë¼ë„ ì¬ì „ì†¡ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.
        - í”„ë¡œë“€ì„œëŠ” ë©”ì‹œì§€ì˜ ì¤‘ë³µ ê°€ëŠ¥ì„±ì„ íšŒí”¼í•˜ê¸° ìœ„í•´ ì¬ì „ì†¡ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ â†’ ì¼ë¶€ ë©”ì‹œì§€ì˜ ì†ì‹¤ì„ ê°ì•ˆí•˜ë”ë¼ë„ ì¤‘ë³µ ì „ì†¡ì€ í•˜ì§€ ì•ŠëŠ” ê²½ìš°
            - ë†’ì€ ì²˜ë¦¬ëŸ‰ì„ í•„ìš”ë¡œ í•˜ëŠ” ëŒ€ëŸ‰ì˜ ë¡œê·¸ ìˆ˜ì§‘ì´ë‚˜ IoT ê°™ì€ í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ê³¤ í•œë‹¤.
    - ì •í™•íˆ í•œ ë²ˆ ì „ì†¡(exactly-once) ğŸ‘‰Â ì¹´í”„ì¹´ì˜ 0.1.1 ë²„ì „ì—ì„œ ì¶”ê°€ëë‹¤.
        
        ![5-7. ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ ê³¼ì •](./images/5/Untitled%206.png)
        
        5-7. ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ ê³¼ì •
        
        - í”„ë¡œë“€ì„œê°€ ì¬ì „ì†¡í•œ ë©”ì‹œì§€Bì˜ í—¤ë”ì—ì„œ PID(0)ì™€ ë©”ì‹œì§€ ë²ˆí˜¸(1)ë¥¼ ë¹„êµí•´ì„œÂ ë©”ì‹œì§€Bê°€ ì´ë¯¸ ë¸Œë¡œì»¤ì— ì €ì¥ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•œ ë¸Œë¡œì»¤ëŠ” ë©”ì‹œì§€ë¥¼ ì¤‘ë³µ ì €ì¥í•˜ì§€ ì•Šê³  ACKë§Œ ë³´ë‚¸ë‹¤Â â†’ ë¸Œë¡œì»¤ì— ì €ì¥ëœ ë©”ì‹œì§€ëŠ” ì¤‘ë³µì„ í”¼í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

- ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì˜ í•µì‹¬: PIDì™€ ë©”ì‹œì§€ ë²ˆí˜¸(ì‹œí€€ìŠ¤ ë²ˆí˜¸)
    - í”„ë¡œë“€ì„œê°€ ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì„ ì‹œì‘í•˜ë©´, í”„ë¡œë“€ì„œëŠ” ê³ ìœ í•œ PIDë¥¼ í• ë‹¹ë°›ê²Œ ë˜ê³ , ì´ PIDì™€ ë©”ì‹œì§€ì— ëŒ€í•œ ë²ˆí˜¸ë¥¼ ë©”ì‹œì§€ì˜ í—¤ë”ì— í¬í•¨í•´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
    - ë¸Œë¡œì»¤ì—ì„œëŠ” ê° ë©”ì‹œì§€ë§ˆë‹¤ PID ê°’ê³¼ ì‹œí€€ìŠ¤ ë²ˆí˜¸ë¥¼ ë©”ëª¨ë¦¬ì— ìœ ì§€í•˜ê²Œ ë˜ë©°, ì´ ì •ë³´ë¥¼ ì´ìš©í•´ ë¸Œë¡œì»¤ì— ê¸°ë¡ëœ ë©”ì‹œì§€ë“¤ì˜ ì¤‘ë³µ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.
        - PIDëŠ” ì‚¬ìš©ìê°€ ë³„ë„ë¡œ ìƒì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë©° í”„ë¡œë“€ì„œì— ì˜í•´ ìë™ ìƒì„±ëœë‹¤.
            - ì‚¬ìš©ìì—ê²Œ ë”°ë¡œ ë…¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.
        - ë©”ì‹œì§€ë§ˆë‹¤ ë¶€ì—¬ë˜ëŠ” ì‹œí€€ìŠ¤ ë²ˆí˜¸ëŠ” 0ë²ˆë¶€í„° ì‹œì‘í•´ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•œë‹¤.
    - í”„ë¡œë“€ì„œì—ì„œ ì‹œí€€ìŠ¤ ë²ˆí˜¸ë¥¼ ë©”ì‹œì§€ë§ˆë‹¤ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€ì‹œí‚¤ëŠ” ë°©ë²•ê³¼ ë™ì¼í•˜ê²Œ, ë¸Œë¡œì»¤ì—ì„œë„ ê¸°ë¡ë˜ëŠ” ë©”ì‹œì§€ë“¤ì— ëŒ€í•´ ì‹œí€€ìŠ¤ ë²ˆí˜¸ë¥¼ ì¦ê°€ì‹œí‚¨ë‹¤.
        
        â†’ í”„ë¡œë“€ì„œê°€ ë³´ë‚¸ ë©”ì‹œì§€ì˜ ì‹œí€€ìŠ¤ ë²ˆí˜¸ê°€ ë¸Œë¡œì»¤ê°€ ê°–ê³  ìˆëŠ” ì‹œí€€ìŠ¤ ë²ˆí˜¸ë³´ë‹¤ ì •í™•í•˜ê²Œ í•˜ë‚˜ í° ê²½ìš°ê°€ ì•„ë‹ˆë¼ë©´, ë¸Œë¡œì»¤ëŠ” í”„ë¡œë“€ì„œì˜ ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤ ğŸ‘‰Â ë©”ì‹œì§€ ì¤‘ë³µì„ í”¼í•  ìˆ˜ ìˆëŠ” ê²ƒ
        
    - PIDì™€ ì‹œí€€ìŠ¤ ë²ˆí˜¸ ì •ë³´ëŠ” ë¸Œë¡œì»¤ì˜ ë©”ëª¨ë¦¬ì— ìœ ì§€ë˜ê³ , ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ì—ë„ ì €ì¥ëœë‹¤.
        
        â†’ ì˜ˆê¸°ì¹˜ ëª»í•œ ë¸Œë¡œì»¤ì˜ ì¥ì•  ë“±ìœ¼ë¡œ ë¦¬ë”ê°€ ë³€ê²½ë˜ëŠ” ì¼ì´ ë°œìƒí•˜ë”ë¼ë„ ìƒˆë¡œìš´ ë¦¬ë”ê°€ PIDì™€ ì‹œí€€ìŠ¤ ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì•Œ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¤‘ë³µ ì—†ëŠ” ë©”ì‹œì§€ ì „ì†¡ì´ ê°€ëŠ¥
        
    - ì»¨í”Œë£¨ì–¸íŠ¸ [ë¸”ë¡œê·¸ ê¸€](https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/)ì— ë”°ë¥´ë©´, ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì„ ì ìš©í•œ í›„ ê¸°ì¡´ ëŒ€ë¹„ ìµœëŒ€ ì•½ 20% ì •ë„ë§Œ ì„±ëŠ¥ì´ ê°ì†Œí–ˆë‹¤.
    
    â—í”„ë¡œë“€ì„œ ì „ì†¡ ì„±ëŠ¥ì— ê·¸ë‹¤ì§€ ë¯¼ê°í•˜ì§€ ì•Šì€ ìƒí™©ì—ì„œ ì¤‘ë³µ ì—†ëŠ” ë©”ì‹œì§€ ì „ì†¡ì´ í•„ìš”ë‹¤í•˜ë©´ ì´ ë°©ì‹ì„ ì„¤ì •í•´ ì ìš©í•  ê²ƒì„ ê¶Œì¥
    
    | í”„ë¡œë“€ì„œ ì˜µì…˜ | ê°’ | ì„¤ëª… |
    | --- | --- | --- |
    | enable.idempotence | true | í”„ë¡œë“€ì„œê°€ ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì„ í—ˆìš©í• ì§€ ê²°ì •í•˜ëŠ” ì˜µì…˜ì´ë‹¤. ê¸°ë³¸ ê°’ì€ falseì´ë¯€ë¡œ, ì´ ì˜µì…˜ì„ ì„¤ì •í•˜ê¸° ì›í•œë‹¤ë©´ trueë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤. trueë¡œ ë³€ê²½ ì‹œ ë‹¤ìŒì— ë‚˜ì˜¤ëŠ” ì˜µì…˜ë“¤ë„ ë°˜ë“œì‹œ ë³€ê²½í•´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ConfigExceptionì´ ë°œìƒí•œë‹¤. |
    | max.in.flight.requests.per.connection | 1 ~ 5 | ACKë¥¼ ë°›ì§€ ì•Šì€ ìƒíƒœì—ì„œ í•˜ë‚˜ì˜ ì»¤ë„¥ì…˜ì—ì„œ ë³´ë‚¼ ìˆ˜ ìˆëŠ” ìµœëŒ€ ìš”ì²­ìˆ˜ì´ë‹¤. ê¸°ë³¸ ê°’ì€ 5ì´ë©°, 5 ì´í•˜ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. |
    | acks | all | í”„ë¡œë“€ì„œ acksì™€ ê´€ë ¨ëœ ì˜µì…˜ìœ¼ë¡œì„œ, ê¸°ë³¸ê°’ì€ 1ì´ë©° allë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. |
    | retries | 5 | ACKë¥¼ ë°›ì§€ ëª»í•œ ê²½ìš° ì¬ì‹œë„ë¥¼ í•´ì•¼ í•˜ë¯€ë¡œ 0ë³´ë‹¤ í° ê°’ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. |
- í”„ë¡œë“€ì„œì˜ ì„¤ì •ê³¼ ë‚´ìš© ì‹¤ìŠµ
    - í† í”½ ìƒì„±
        
        ```bash
        root@kafka1:/# kafka-topics --bootstrap-server kafka1:9091 --create --topic peter-test04 --partitions 1 --replication-factor 3
        Created topic peter-test04.
        ```
        
        ![Untitled](./images/5/Untitled%207.png)
        
    - `vi` ì„¤ì¹˜
        
        ```bash
        root@kafka1:/# apt-get update
        root@kafka1:/# apt-get install vim
        ```
        
    - ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì„ ìœ„í•œ `producer.config` íŒŒì¼ ìƒì„±
        - `ack` ì˜µì…˜ì„ ì¶”ê°€ x â†’ ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì„ ìœ„í•œ í•„ìˆ«ê°’ì¸ acks ì˜µì…˜ì„ ì¶”ê°€í•˜ì§€ ì•Šì•˜ì„ ë•Œ ğŸ‘‰Â ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì„ ìœ„í•œ ì¼ë¶€ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— `ConfigException`ì´ ë°œìƒ
            
            ```bash
            enable.idempotence=true
            max.in.flight.requests.per.connection=5
            retries=5
            ```
            
            - í”„ë¡œë“€ì„œ ì„¤ì • íŒŒì¼ì„ ë¡œë“œ, `--producer.config`ë¼ëŠ” ì˜µì…˜ì„ ì¶”ê°€í•´ ëª…ë ¹ì–´ë¥¼ ì…ë ¥
                
                ```bash
                root@kafka1:/# kafka-console-producer --bootstrap-server kafka1:9091 --topic peter-test04 --producer.config /producer.config
                org.apache.kafka.common.config.ConfigException: Must set acks to all in order to use the idempotent producer. Otherwise we cannot guarantee idempotence.
                	at org.apache.kafka.clients.producer.ProducerConfig.maybeOverrideAcksAndRetries(ProducerConfig.java:439)
                	at org.apache.kafka.clients.producer.ProducerConfig.postProcessParsedConfig(ProducerConfig.java:400)
                	at org.apache.kafka.common.config.AbstractConfig.<init>(AbstractConfig.java:110)
                	at org.apache.kafka.common.config.AbstractConfig.<init>(AbstractConfig.java:129)
                	at org.apache.kafka.clients.producer.ProducerConfig.<init>(ProducerConfig.java:481)
                	at org.apache.kafka.clients.producer.KafkaProducer.<init>(KafkaProducer.java:326)
                	at org.apache.kafka.clients.producer.KafkaProducer.<init>(KafkaProducer.java:298)
                	at kafka.tools.ConsoleProducer$.main(ConsoleProducer.scala:45)
                	at kafka.tools.ConsoleProducer.main(ConsoleProducer.scala)
                ```
                
        - `ack=all`ì„ ì¶”ê°€í•œ í›„ ì½˜ì†” í”„ë¡œë“€ì„œë¥¼ ë‹¤ì‹œ ì‹¤í–‰ â†’ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆëŠ” `>` ì»¤ë§¨ë“œê°€ ë‚˜íƒ€ë‚œë‹¤. ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œ í›„ ì½˜ì†” í”„ë¡œë“€ì„œë¥¼ ì¢…ë£Œ.
            
            ```bash
            root@kafka3:/var/lib/kafka/data/peter-test04-0# ls
            00000000000000000000.index  00000000000000000000.timeindex
            00000000000000000000.log    leader-epoch-checkpoint
            ```
            
            ```bash
            root@kafka1:/# kafka-console-producer --bootstrap-server kafka1:9091 --topic peter-test04 --producer.config /producer.config
            >exactly once1
            >
            ```
            
    - ë¸Œë¡œì»¤ì˜ í† í”½ ë©”ì‹œì§€ê°€ ì €ì¥ëœ ê²½ë¡œë¡œ ì´ë™(`/data/kafka-logs`) ğŸ‘‰ ë„ì»¤ë¡œ ì„¤ì¹˜í•œ ê²½ìš° `/var/lib/kafka/data`
        - `â€”-bootstrap-server` ë‹¤ì‹œë³´ê¸°
            - (ì°¸ê³ ) í† í”½ ìƒì„±Â ì‹œ `--zookeeper`ê°€ ì•„ë‹ˆë¼ `--bootstrap-server` ì˜µì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”Â ì¹´í”„ì¹´ 2.1ì„ í¬í•¨í•œ ì´ì „ ë²„ì „ì—ì„œëŠ” ì¼ë¶€ ì¹´í”„ì¹´ ì»¤ë§¨ë“œ ë¼ì¸ íˆ´ì´ ì£¼í‚¤í¼ì™€ ì§ì ‘ í†µì‹ í•˜ì—¬ ëª…ë ¹ì„ ì‹¤í–‰í–ˆìœ¼ë‚˜, ì¹´í”„ì¹´ 2.2 ë²„ì „ ì´í›„ë¡œëŠ” ì£¼í‚¤í¼ì™€ í†µì‹ í•˜ëŠ” ëŒ€ì‹  ì¹´í”„ì¹´ë¥¼ í†µí•´ í† í”½ê³¼ ê´€ë ¨ëœ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆê¸° ë•Œë¬¸
        - ì£¼í‚¤í¼ë¥¼ ì•ˆë„ê³  ë„ì»¤ ì»¨í…Œì´ë„ˆ `stop` í–ˆë”ë‹ˆ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„° ë‚´ ëª¨ë“  ë¸Œë¡œì»¤ë¥¼ ë‹¤ ì£½ì¸í›„ì—ì•¼ ë§ˆì§€ë§‰ `stop`í•œ ë¸Œë¡œì»¤ì—ì„œ snapshot íŒŒì¼ì„ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤â€¦
        
        ```bash
        root@kafka1:/var/lib/kafka/data/peter-test04-0# ls
        00000000000000000000.index  00000000000000000000.timeindex  leader-epoch-checkpoint
        00000000000000000000.log    00000000000000000001.snapshot
        ```
        
    - ì¹´í”„ì¹´ì˜ `dump` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ snapshot íŒŒì¼ì„ í™•ì¸
        
        ```bash
        root@kafka1:/var/lib/kafka/data/peter-test04-0# kafka-dump-log --print-data-log --files /var/lib/kafka/data/peter-test04-0/00000000000000000001.snapshot
        Dumping /var/lib/kafka/data/peter-test04-0/00000000000000000001.snapshot
        producerId: 95001 producerEpoch: 0 coordinatorEpoch: -1 currentTxnFirstOffset: None firstSequence: 0 lastSequence: 0 lastOffset: 0 offsetDelta: 0 timestamp: 1663479722874
        ```
        

<aside>
ğŸ’¡ PIDì™€ ì‹œí€€ìŠ¤ ë²ˆí˜¸ê°€ ë¸Œë¡œì»¤ì— ì €ì¥ëœë‹¤

</aside>

## 4. ì •í™•íˆ í•œ ë²ˆ ì „ì†¡

---

- ì¹´í”„ì¹´ì—ì„œ ì •í™•íˆ í•œ ë²ˆ ì „ì†¡: íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ ì „ì²´ì ì¸ í”„ë¡œì„¸ìŠ¤ ì²˜ë¦¬ë¥¼ ì˜ë¯¸
    - ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ì€ ì •í™•íˆ í•œ ë²ˆ ì „ì†¡ì˜ ì¼ë¶€ ê¸°ëŠ¥
- ì „ì²´ì ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì¹´í”„ì¹´ì—ì„œëŠ” ì •í™•íˆ í•œ ë²ˆ ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ê°€ ìˆëŠ”ë° ì´ë¥¼Â íŠ¸ëœì­ì…˜ APIÂ ë¼ê³  ë¶€ë¥¸ë‹¤.

### 4-1. ë””ìì¸

---

- í”„ë¡œë“€ì„œê°€ ì¹´í”„ì¹´ë¡œ ì •í™•íˆ í•œ ë²ˆ ë°©ì‹ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ë•Œ, í”„ë¡œë“€ì„œê°€ ë³´ë‚´ëŠ” ë©”ì‹œì§€ë“¤ì€ ì›ìì ìœ¼ë¡œ(atomic) ì²˜ë¦¬ë˜ì–´ ì „ì†¡ì— ì„±ê³µí•˜ê±°ë‚˜ ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤.
- ì´ëŸ° í”„ë¡œë“€ì„œì˜ ì „ì†¡ì„ ìœ„í•´ ì¹´í”„ì¹´ì—ëŠ” ì»¨ìŠˆë¨¸ ê·¸ë£¹ ì½”ë””ë„¤ì´í„°ì™€ ë™ì¼í•œ ê°œë…ìœ¼ë¡œÂ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°(transaction coordinator)ë¼ëŠ” ê²ƒì´ ì„œë²„ ì¸¡ì— ì¡´ì¬í•œë‹¤.
    - í”„ë¡œë“€ì„œì— ì˜í•´ ì „ì†¡ëœ ë©”ì‹œì§€ë¥¼ ê´€ë¦¬í•˜ë©°, ì»¤ë°‹ ë˜ëŠ” ì¤‘ë‹¨ ë“±ì„ í‘œì‹œí•œë‹¤.
    - ì¹´í”„ì¹´ì—ì„œëŠ” ì»¨ìŠˆë¨¸ ì˜¤í”„ì…‹ ê´€ë¦¬ë¥¼ ìœ„í•´ ì˜¤í”„ì…‹ ì •ë³´ë¥¼ ì¹´í”„ì¹´ì˜ ë‚´ë¶€ í† í”½ì— ì €ì¥í•˜ëŠ”ë°, íŠ¸ëœì­ì…˜ë„ ë™ì¼í•˜ê²Œ íŠ¸ëœì­ì…˜ ë¡œê·¸ë¥¼ ì¹´í”„ì¹´ì˜ ë‚´ë¶€ í† í”½ì¸ `__transaction_state`ì— ì €ì¥í•œë‹¤.
    - `__transaction_state`ëŠ” ì¹´í”„ì¹´ì˜ ë‚´ë¶€ í† í”½ì´ì§€ë§Œ ì´ ì—­ì‹œ í† í”½ì´ë¯€ë¡œ íŒŒí‹°ì…˜ ìˆ˜ì™€ ë¦¬í”Œë¦¬ì¼€ì´ì…˜ íŒ©í„° ìˆ˜ê°€ ì¡´ì¬í•˜ë©°, ë¸Œë¡œì»¤ì˜ ì„¤ì •ì„ í†µí•´ ê´€ë¦¬ìê°€ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
        - ê¸°ë³¸ê°’
            - `transaction.state.log.num.partitions`=50
            - `transaction.state.log.replication.factor`=3
        - í”„ë¡œë“€ì„œëŠ” íŠ¸ëœì­ì…˜ ê´€ë ¨ ì •ë³´ë¥¼ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì—ê²Œ ì•Œë¦¬ê³ , ëª¨ë“  ì •ë³´ì˜ ë¡œê·¸ëŠ” íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ê°€ ì§ì ‘ ê¸°ë¡í•œë‹¤.
- ì¹´í”„ì¹´ ë©”ì‹œì§€ë¥¼ ë‹¤ë£¨ëŠ” í´ë¼ì´ì–¸íŠ¸ë“¤ì€ í•´ë‹¹ ë©”ì‹œì§€ë“¤ì´ ì •ìƒì ìœ¼ë¡œ ì»¤ë°‹ëœ ê²ƒì¸ì§€ ë˜ëŠ” ì‹¤íŒ¨í•œ ê²ƒì¸ì§€ ì‹ë³„í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
    - ì´ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•œ ì •ë³´ë¡œì„œ,Â ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€ë¼ê³  ë¶ˆë¦¬ëŠ” íŠ¹ë³„í•œ íƒ€ì…ì˜ ë©”ì‹œì§€ê°€ ì¶”ê°€ë¡œ ì‚¬ìš©ëœë‹¤.
    - ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€ëŠ” í˜ì´ë¡œë“œì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°ì´í„°(ë©”ì‹œì§€ì˜ ë°¸ë¥˜)ë¥¼ í¬í•¨í•˜ì§€ ì•Šìœ¼ë©°, ì• í”Œë¦¬ì¼€ì´ì…˜ë“¤ì—ê²Œ ë…¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.
    - ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€ëŠ” ì˜¤ì§ ë¸Œë¡œì»¤ì™€ í´ë¼ì´ì–¸íŠ¸ í†µì‹ ì—ì„œë§Œ ì‚¬ìš©ëœë‹¤.****

### 4-2. í”„ë¡œë“€ì„œ ì˜ˆì œ ì½”ë“œ

---

- íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œ ì˜ˆì œ ì½”ë“œ
    
    ```java
    package com.jenny.kafka.chapter5;
    
    import org.apache.kafka.clients.producer.KafkaProducer;
    import org.apache.kafka.clients.producer.Producer;
    import org.apache.kafka.clients.producer.ProducerConfig;
    import org.apache.kafka.clients.producer.ProducerRecord;
    import org.apache.kafka.common.serialization.StringSerializer;
    
    import java.util.Properties;
    
    public class ExactlyOnceProducer {
        public static void main(String[] args) {
            String bootstrapServers = "kafka1:9091";
            Properties props = new Properties();
            props.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
            props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
            props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
            // s: 1. ì •í™•íˆ í•œë²ˆ ì „ì†¡ì„ ìœ„í•œ ì„¤ì •
            props.setProperty(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, "true");
            props.setProperty(ProducerConfig.ACKS_CONFIG, "all");
            props.setProperty(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION, "5");
            props.setProperty(ProducerConfig.RETRIES_CONFIG, "5");
            props.setProperty(ProducerConfig.TRANSACTIONAL_ID_CONFIG, "peter-transaction-01");
            // e: 1. ì •í™•íˆ í•œë²ˆ ì „ì†¡ì„ ìœ„í•œ ì„¤ì •
    
            Producer<String, String> producer = new KafkaProducer<>(props);
    
            // 2. í”„ë¡œë“€ì„œ íŠ¸ëœì­ì…˜ ì´ˆê¸°í™”
            producer.initTransactions();
            // 3. í”„ë¡œë“€ì„œ íŠ¸ëœì­ì…˜ ì‹œì‘
            producer.beginTransaction();
            try {
                for (int i = 0; i < 1; i++) {
                    ProducerRecord<String, String> record = new ProducerRecord<>("peter-test05", "Apache Kafka is a distributed streaming platform - " + i);
                    producer.send(record);
                    producer.flush();
                    System.out.println("Message sent successfully");
                }
            } catch (Exception e) {
                // 4. í”„ë¡œë“€ì„œ íŠ¸ëœì­ì…˜ ì¤‘ë‹¨
                producer.abortTransaction();
                e.printStackTrace();
            } finally {
                // 5. í”„ë¡œë“€ì„œ íŠ¸ëœì­ì…˜ ì»¤ë°‹
                producer.commitTransaction();
                producer.close();
            }
        }
    }
    ```
    
- `TRANSACTIONAL_ID_CONFIG`: ì¤‘ë³µ ì—†ëŠ” ì „ì†¡ê³¼ ì •í™•íˆ í•œ ë²ˆ ì „ì†¡ì˜ ì˜µì…˜ ì„¤ì •ì—ì„œ ê°€ì¥ í° ì°¨ì´ì ì´ì ì£¼ì˜í•´ì•¼ í•  ì„¤ì •
    - í”„ë¡œë“€ì„œì˜ `TRANSACTIONAL_ID_CONFIG` ì˜µì…˜ì€ ì‹¤í–‰í•˜ëŠ” í”„ë¡œë“€ì„œ í”„ë¡œì„¸ìŠ¤ë§ˆë‹¤ ê³ ìœ í•œ ì•„ì´ë””ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.
- 2ê°œì˜ í”„ë¡œë“€ì„œê°€ ìˆë‹¤ë©´ ë‘ í”„ë¡œë“€ì„œë§ˆë‹¤ ë‹¤ë¥¸ ì•„ì´ë””ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.****

### 4-3. ë‹¨ê³„ë³„ ë™ì‘

---

![5-8. íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„° ì°¾ê¸°](./images/5/Untitled%208.png)

5-8. íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„° ì°¾ê¸°

- ì •í™•íˆ í•œ ë²ˆ ì „ì†¡ì„ ìœ„í•´ì„œëŠ” íŠ¸ëœì­ì…˜ API ë¥¼ ì´ìš©
    - ê°€ì¥ ë¨¼ì € ìˆ˜í–‰í•˜ëŠ” ì‘ì—…ì€ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„° ì°¾ê¸°
- í”„ë¡œë“€ì„œëŠ” ë¸Œë¡œì»¤ì—ê²Œ `FindCoordinatorRequest`ë¥¼ ë³´ë‚´ì„œ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì˜ ìœ„ì¹˜ë¥¼ ì°¾ëŠ”ë‹¤.
- ì»¨ìŠˆë¨¸ ì½”ë””ë„¤ì´í„°ì™€ ìœ ì‚¬í•œ ì—­í• ì„ í•˜ëŠ” íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ë¸Œë¡œì»¤ì— ìœ„ì¹˜í•œë‹¤.
    - ì£¼ ì—­í• ì€ PID(Producer ID)ì™€ `transactional.id`ë¥¼ ë§¤í•‘í•˜ê³  í•´ë‹¹ íŠ¸ëœì­ì…˜ ì „ì²´ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒ
    - ë§Œì•½ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì‹ ê·œ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ê°€ ìƒì„±ëœë‹¤.
- `__transaction_state` í† í”½ì˜ íŒŒí‹°ì…˜ ë²ˆí˜¸ëŠ” `transactional.id`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•´ì‹œí•˜ì—¬ ê²°ì •ë˜ê³ ,Â ì´ íŒŒí‹°ì…˜ì˜ ë¦¬ë”ê°€ ìˆëŠ” ë¸Œë¡œì»¤ê°€ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì˜ ë¸Œë¡œì»¤ë¡œ ìµœì¢… ì„ ì •ëœë‹¤.

<aside>
ğŸ’¡ `transactional.id`ê°€ ì •í™•íˆ í•˜ë‚˜ì˜ ì½”ë””ë„¤ì´í„°ë§Œ ê°–ê³  ìˆë‹¤.

</aside>

![5-9. í”„ë¡œë“€ì„œ ì´ˆê¸°í™”](./images/5/Untitled%209.png)

5-9. í”„ë¡œë“€ì„œ ì´ˆê¸°í™”

- í”„ë¡œë“€ì„œëŠ” `initTransactions()` ë©”ì†Œë“œë¥¼ ì´ìš©í•´ íŠ¸ëœì­ì…˜ ì „ì†¡ì„ ìœ„í•œ `InitPidRequest`ë¥¼ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ë¡œ ë³´ë‚¸ë‹¤.
- ì´ë•Œ TID(`transactional.id`)ê°€ ì„¤ì •ëœ ê²½ìš°ì—ëŠ” `InitPidRequest`ì™€ í•¨ê»˜ TIDê°€ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì—ê²Œ ì „ì†¡ëœë‹¤.
- íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” TID, PIDë¥¼ ë§¤í•‘í•˜ê³  í•´ë‹¹ ì •ë³´ë¥¼ íŠ¸ëœì­ì…˜ ë¡œê·¸ì— ê¸°ë¡í•œë‹¤.
- ê·¸ëŸ° ë‹¤ìŒ PID ì—í¬í¬ë¥¼ í•œ ë‹¨ê³„ ì˜¬ë¦¬ëŠ” ë™ì‘ì„ í•˜ê²Œ ë˜ê³ , PID ì—í¬í¬ê°€ ì˜¬ë¼ê°ì— ë”°ë¼ ì´ì „ì˜ ë™ì¼í•œ PIDì™€ ì´ì „ ì—í¬í¬ì— ëŒ€í•œ ì“°ê¸° ìš”ì²­ì€ ë¬´ì‹œëœë‹¤.

![5-10. íŠ¸ëœì­ì…˜ ì‹œì‘](./images/5/Untitled%2010.png)

5-10. íŠ¸ëœì­ì…˜ ì‹œì‘

- í”„ë¡œë“€ì„œëŠ” `beginTransaction()` ë©”ì†Œë“œë¥¼ ì´ìš©í•´ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ì„ ì•Œë¦¬ê²Œ ëœë‹¤.
- í”„ë¡œë“€ì„œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëìŒì„ ê¸°ë¡í•˜ì§€ë§Œ, íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„° ê´€ì ì—ì„œëŠ” ì²« ë²ˆì§¸ ë ˆì½”ë“œê°€ ì „ì†¡ë  ë•Œê¹Œì§€ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ê²ƒì€ ì•„ë‹ˆë‹¤.

![5-11. íŠ¸ëœì­ì…˜ ìƒíƒœ ì¶”ê°€](./images/5/Untitled%2011.png)

5-11. íŠ¸ëœì­ì…˜ ìƒíƒœ ì¶”ê°€

- íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ì „ì²´ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•œë‹¤.
    - í”„ë¡œë“€ì„œëŠ” í† í”½ íŒŒí‹°ì…˜ ì •ë³´ë¥¼ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì—ê²Œ ì „ë‹¬í•˜ê³ , íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” í•´ë‹¹ ì •ë³´ë¥¼ íŠ¸ëœì­ì…˜ ë¡œê·¸ì— ê¸°ë¡í•œë‹¤.
- TID ì™€ P0(íŒŒí‹°ì…˜0)ì˜ ì •ë³´ê°€ íŠ¸ëœì­ì…˜ ë¡œê·¸ì— ê¸°ë¡ë˜ë©°, íŠ¸ëœì­ì…˜ì˜ í˜„ì¬ ìƒíƒœë¥¼ Ongoing ìœ¼ë¡œ í‘œì‹œ
- ë§Œì•½ íŠ¸ëœì­ì…˜ ë¡œê·¸ì— ì¶”ê°€ë˜ëŠ” ì²« ë²ˆì§¸ íŒŒí‹°ì…˜ì´ë¼ë©´, íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” í•´ë‹¹ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•œë‹¤.
    - ê¸°ë³¸ê°’ìœ¼ë¡œ 1ë¶„ ë™ì•ˆ íŠ¸ëœì­ì…˜ ìƒíƒœì— ëŒ€í•œ ì—…ë°ì´íŠ¸ê°€ ì—†ë‹¤ë©´, í•´ë‹¹ íŠ¸ëœì­ì…˜ì€ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬ëœë‹¤.

![5-12. ë©”ì‹œì§€ ì „ì†¡](./images/5/Untitled%2012.png)

5-12. ë©”ì‹œì§€ ì „ì†¡

- ì´ ë‹¨ê³„ì—ì„œ í”„ë¡œë“€ì„œëŠ” ëŒ€ìƒ í† í”½ì˜ íŒŒí‹°ì…˜ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
- P0(íŒŒí‹°ì…˜0)ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆê³ , í•´ë‹¹ ë©”ì‹œì§€ì—ëŠ” PID, ì—í¬í¬, ì‹œí€€ìŠ¤ ë²ˆí˜¸ê°€ í•¨ê»˜ í¬í•¨ë˜ì–´ ì „ì†¡ëœë‹¤.
    - ê·¸ë¦¼ 5-12ì—ì„œ ë¸Œë¡œì»¤ê°€ 2ê°œ ìˆëŠ” ì´ìœ ëŠ” íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ê°€ ìˆëŠ” ë¸Œë¡œì»¤ì™€ í”„ë¡œë“€ì„œê°€ ì „ì†¡í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ë°›ëŠ” ë¸Œë¡œì»¤ê°€ ì„œë¡œ ë‹¤ë¥´ê¸° ë•Œë¬¸ì´ë‹¤.

![5-13. íŠ¸ëœì­ì…˜ ì¢…ë£Œ ìš”ì²­](./images/5/Untitled%2013.png)

5-13. íŠ¸ëœì­ì…˜ ì¢…ë£Œ ìš”ì²­

- ë©”ì‹œì§€ ì „ì†¡ì„ ì™„ë£Œí•œ í”„ë¡œë“€ì„œëŠ” `commitTransaction()` ë©”ì†Œë“œ ë˜ëŠ” `abortTransaction()` ë©”ì†Œë“œ ì¤‘ í•˜ë‚˜ë¥¼ ë°˜ë“œì‹œ í˜¸ì¶œí•´ì•¼ í•˜ë©°, í•´ë‹¹ ë©”ì†Œë“œì˜ í˜¸ì¶œì„ í†µí•´ íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë¨ì„ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì—ê²Œ ì•Œë¦°ë‹¤.
- íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ë‘ ë‹¨ê³„ì˜ ì»¤ë°‹ ê³¼ì •ì„ ì‹œì‘í•˜ê²Œ ë˜ë©°, ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ íŠ¸ëœì­ì…˜ ë¡œê·¸ì— í•´ë‹¹ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ `PrepareCommit` ë˜ëŠ” `PrepareAbort`ë¥¼ ê¸°ë¡í•œë‹¤.

![5-14. ì‚¬ìš©ì í† í”½ì— í‘œì‹œ ìš”ì²­](./images/5/Untitled%2014.png)

5-14. ì‚¬ìš©ì í† í”½ì— í‘œì‹œ ìš”ì²­

- íŠ¸ë¦°ì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ë‘ ë²ˆì§¸ ë‹¨ê³„ë¡œì„œ íŠ¸ëœì­ì…˜ ë¡œê·¸ì— ê¸°ë¡ëœ í† í”½ì˜ íŒŒí‹°ì…˜ì— íŠ¸ëœì­ì…˜ ì»¤ë°‹ í‘œì‹œë¥¼ ê¸°ë¡í•œë‹¤.
    - ì—¬ê¸°ì„œ ê¸°ë¡í•˜ëŠ” ë©”ì‹œì§€ê°€ ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€
    - ì´ ë©”ì‹œì§€ëŠ” í•´ë‹¹ PIDì˜ ë©”ì‹œì§€ê°€ ì œëŒ€ë¡œ ì „ì†¡ëëŠ”ì§€ ì—¬ë¶€ë¥¼ ì»¨ìŠˆë¨¸ì—ê²Œ ë‚˜íƒ€ë‚´ëŠ” ìš©ë„ë¡œë„ ì‚¬ìš©ëœë‹¤.
    - íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ì´ ëë‚˜ì§€ ì•Šì€ ë©”ì‹œì§€ëŠ” ì»¨ìŠˆë¨¸ì—ê²Œ ë°˜í™˜í•˜ì§€ ì•Šìœ¼ë©°, ì˜¤í”„ì…‹ì˜ ìˆœì„œ ë³´ì¥ì„ ìœ„í•´ íŠ¸ëœì­ì…˜ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ë¥¼ ë‚˜íƒ€ë‚´ëŠ”Â LSO(last stable offset)ë¼ëŠ” ì˜¤í”„ì…‹ì„ ìœ ì§€í•˜ê²Œ ëœë‹¤.

![5-15. íŠ¸ëœì­ì…˜ ì™„ë£Œ](./images/5/Untitled%2015.png)

5-15. íŠ¸ëœì­ì…˜ ì™„ë£Œ

- íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ì™„ë£Œë¨(committed)ì´ë¼ê³  íŠ¸ëœì­ì…˜ ë¡œê·¸ì— ê¸°ë¡í•œë‹¤.
- í”„ë¡œë“€ì„œì—ê²Œ í•´ë‹¹ íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë¨ì„ ì•Œë¦° ë‹¤ìŒ í•´ë‹¹ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ ì²˜ë¦¬ëŠ” ëª¨ë‘ ë§ˆë¬´ë¦¬ëœë‹¤.
- íŠ¸ëœì­ì…˜ì„ ì´ìš©í•˜ëŠ” ì»¨ìŠˆë¨¸ëŠ” `read_committed` ì„¤ì •ì„ í•˜ë©´ íŠ¸ëœì­ì…˜ì— ì„±ê³µí•œ ë©”ì‹œì§€ë“¤ë§Œ ì½ì„ ìˆ˜ ìˆê²Œ ëœë‹¤.

### 4-4. ì˜ˆì œ ì‹¤ìŠµ

---

- ì •í™•íˆ í•œ ë²ˆ ì „ì†¡ ì‹¤ìŠµ
    - í† í”½ ìƒì„±
        
        ```java
        root@kafka1:/# kafka-topics --bootstrap-server kafka1:9091 --create --topic peter-test05 --partitions 1 --replication-factor 3
        Created topic peter-test05.
        ```
        
    - `jar`ë¡œ ë¹Œë“œí•œ í›„ í˜¸ìŠ¤íŠ¸ â†’ ì»¨í…Œì´ë„ˆ ë¡œ JAR íŒŒì¼ ë³µì‚¬
        
        ```java
        docker cp /Users/kim-yoonhee/IdeaProjects/kafka-study/build/libs/kafka-study-1.0-SNAPSHOT.jar a2e5a31f90a:/
        ```
        
    - JaríŒŒì¼ì„ ì‹¤í–‰í•´ì„œ íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œë¥¼ ì´ìš©í•œ ë©”ì‹œì§€ ì „ì†¡
        - ì»¨ìŠˆë¨¸ë¥¼ ì¼œë†“ê³  ì‹¤í–‰í•´ì•¼ í•œë‹¤.
            
            ```java
            kafka-console-consumer --bootstrap-server kafka1:9091 --topic peter-test05
            ```
            
        
        ![Untitled](./images/5/Untitled%2016.png)
        
        ```java
        Message sent successfully
        
        Deprecated Gradle features were used in this build, making it incompatible with Gradle 8.0.
        
        You can use '--warning-mode all' to show the individual deprecation warnings and determine if they come from your own scripts or plugins.
        
        See https://docs.gradle.org/7.4/userguide/command_line_interface.html#sec:command_line_warnings
        
        BUILD SUCCESSFUL in 1s
        2 actionable tasks: 1 executed, 1 up-to-date
        [main] INFO org.apache.kafka.clients.producer.ProducerConfig - ProducerConfig values: 
        	acks = -1
        	batch.size = 16384
        	bootstrap.servers = [0.0.0.0:9091]
        	buffer.memory = 33554432
        	client.dns.lookup = use_all_dns_ips
        	client.id = producer-peter-transaction-01
        	compression.type = none
        	connections.max.idle.ms = 540000
        	delivery.timeout.ms = 120000
        	enable.idempotence = true
        	interceptor.classes = []
        	internal.auto.downgrade.txn.commit = false
        	key.serializer = class org.apache.kafka.common.serialization.StringSerializer
        	linger.ms = 0
        	max.block.ms = 60000
        	max.in.flight.requests.per.connection = 5
        	max.request.size = 1048576
        	metadata.max.age.ms = 300000
        	metadata.max.idle.ms = 300000
        	metric.reporters = []
        	metrics.num.samples = 2
        	metrics.recording.level = INFO
        	metrics.sample.window.ms = 30000
        	partitioner.class = class org.apache.kafka.clients.producer.internals.DefaultPartitioner
        	receive.buffer.bytes = 32768
        	reconnect.backoff.max.ms = 1000
        	reconnect.backoff.ms = 50
        	request.timeout.ms = 30000
        	retries = 5
        	retry.backoff.ms = 100
        	sasl.client.callback.handler.class = null
        	sasl.jaas.config = null
        	sasl.kerberos.kinit.cmd = /usr/bin/kinit
        	sasl.kerberos.min.time.before.relogin = 60000
        	sasl.kerberos.service.name = null
        	sasl.kerberos.ticket.renew.jitter = 0.05
        	sasl.kerberos.ticket.renew.window.factor = 0.8
        	sasl.login.callback.handler.class = null
        	sasl.login.class = null
        	sasl.login.refresh.buffer.seconds = 300
        	sasl.login.refresh.min.period.seconds = 60
        	sasl.login.refresh.window.factor = 0.8
        	sasl.login.refresh.window.jitter = 0.05
        	sasl.mechanism = GSSAPI
        	security.protocol = PLAINTEXT
        	security.providers = null
        	send.buffer.bytes = 131072
        	socket.connection.setup.timeout.max.ms = 127000
        	socket.connection.setup.timeout.ms = 10000
        	ssl.cipher.suites = null
        	ssl.enabled.protocols = [TLSv1.2]
        	ssl.endpoint.identification.algorithm = https
        	ssl.engine.factory.class = null
        	ssl.key.password = null
        	ssl.keymanager.algorithm = SunX509
        	ssl.keystore.certificate.chain = null
        	ssl.keystore.key = null
        	ssl.keystore.location = null
        	ssl.keystore.password = null
        	ssl.keystore.type = JKS
        	ssl.protocol = TLSv1.2
        	ssl.provider = null
        	ssl.secure.random.implementation = null
        	ssl.trustmanager.algorithm = PKIX
        	ssl.truststore.certificates = null
        	ssl.truststore.location = null
        	ssl.truststore.password = null
        	ssl.truststore.type = JKS
        	transaction.timeout.ms = 60000
        	transactional.id = peter-transaction-01
        	value.serializer = class org.apache.kafka.common.serialization.StringSerializer
        
        [main] INFO org.apache.kafka.clients.producer.KafkaProducer - [Producer clientId=producer-peter-transaction-01, transactionalId=peter-transaction-01] Instantiated a transactional producer.
        [main] INFO org.apache.kafka.common.utils.AppInfoParser - Kafka version: 2.7.0
        [main] INFO org.apache.kafka.common.utils.AppInfoParser - Kafka commitId: 448719dc99a19793
        [main] INFO org.apache.kafka.common.utils.AppInfoParser - Kafka startTimeMs: 1663504645211
        [main] INFO org.apache.kafka.clients.producer.internals.TransactionManager - [Producer clientId=producer-peter-transaction-01, transactionalId=peter-transaction-01] Invoking InitProducerId for the first time in order to acquire a producer ID
        [kafka-producer-network-thread | producer-peter-transaction-01] INFO org.apache.kafka.clients.Metadata - [Producer clientId=producer-peter-transaction-01, transactionalId=peter-transaction-01] Cluster ID: QHoOqqyxSGmQKX9wDVuHnA
        [kafka-producer-network-thread | producer-peter-transaction-01] INFO org.apache.kafka.clients.producer.internals.TransactionManager - [Producer clientId=producer-peter-transaction-01, transactionalId=peter-transaction-01] Discovered transaction coordinator kafka1:9091 (id: 1 rack: null)
        [kafka-producer-network-thread | producer-peter-transaction-01] INFO org.apache.kafka.clients.producer.internals.TransactionManager - [Producer clientId=producer-peter-transaction-01, transactionalId=peter-transaction-01] ProducerId set to 108000 with epoch 6
        [main] INFO org.apache.kafka.clients.producer.KafkaProducer - [Producer clientId=producer-peter-transaction-01, transactionalId=peter-transaction-01] Closing the Kafka producer with timeoutMillis = 9223372036854775807 ms.
        [main] INFO org.apache.kafka.common.metrics.Metrics - Metrics scheduler closed
        [main] INFO org.apache.kafka.common.metrics.Metrics - Closing reporter org.apache.kafka.common.metrics.JmxReporter
        [main] INFO org.apache.kafka.common.metrics.Metrics - Metrics reporters closed
        [main] INFO org.apache.kafka.common.utils.AppInfoParser - App info kafka.producer for producer-peter-transaction-01 unregistered
        ```
        
    - ë¸Œë¡œì»¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ kafka1 ì„œë²„ë¡œ ì ‘ê·¼í•œ í›„ ì¹´í”„ì¹´ì˜ ì „ì²´ í† í”½ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸
        
        ```java
        root@kafka1:/# kafka-topics --bootstrap-server kafka1:9091 --list
        __confluent.support.metrics
        __consumer_offsets
        __transaction_state
        peter-overview01
        peter-test01
        peter-test02
        peter-test03
        peter-test04
        peter-test05
        ```
        
        - ì˜ˆì „ì—ëŠ” í™•ì¸í•  ìˆ˜ ì—†ì—ˆë˜ `__transaction_state`ë¼ëŠ” í† í”½ì´ ìˆë‹¤.
            - íŠ¸ëœì­ì…˜ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ëŠ” ì¹´í”„ì¹´ì˜ ë‚´ë¶€ í† í”½
    - ì½˜ì†” ì»¨ìŠˆë¨¸ë¡œ í•´ë‹¹ í† í”½ì˜ ë‚´ìš©ì„ ì½ê¸° ìœ„í•´ì„œëŠ” ì»¨ìŠˆë¨¸ ì˜µì…˜ì„ í•˜ë‚˜ ì¶”ê°€í•´ì•¼ í•œë‹¤.
        
        ```bash
        # consumer.config
        exclude.internal.topics=false
        ```
        
    - `__transaction_state` í† í”½ì˜ ë‚´ìš©ì„ ì½ê¸°
        
        ```bash
        root@kafka1:/# kafka-console-consumer --bootstrap-server kafka1:9091 --topic __transaction_state --consumer.config /consumer.config --formatter "kafka.coordinator.transaction.TransactionLog\$TransactionLogMessageFormatter" --from-beginning
        ```
        
        ```bash
        ...
        # 1
        peter-transaction-01::TransactionMetadata(transactionalId=peter-transaction-01, producerId=108000, producerEpoch=2, txnTimeoutMs=60000, state=Empty, pendingState=None, topicPartitions=Set(), txnStartTimestamp=-1, txnLastUpdateTimestamp=1663504274175)
        # 2
        peter-transaction-01::TransactionMetadata(transactionalId=peter-transaction-01, producerId=108000, producerEpoch=2, txnTimeoutMs=60000, state=Ongoing, pendingState=None, topicPartitions=Set(peter-test05-0), txnStartTimestamp=1663504274249, txnLastUpdateTimestamp=1663504274249)
        # 3
        peter-transaction-01::TransactionMetadata(transactionalId=peter-transaction-01, producerId=108000, producerEpoch=2, txnTimeoutMs=60000, state=PrepareCommit, pendingState=None, topicPartitions=Set(peter-test05-0), txnStartTimestamp=1663504274249, txnLastUpdateTimestamp=1663504274404)
        # 4
        peter-transaction-01::TransactionMetadata(transactionalId=peter-transaction-01, producerId=108000, producerEpoch=2, txnTimeoutMs=60000, state=CompleteCommit, pendingState=None, topicPartitions=Set(), txnStartTimestamp=1663504274249, txnLastUpdateTimestamp=1663504274442)
        ...
        ```
        
        1. ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ íŠ¸ëœì­ì…˜ ì´ˆê¸°í™”ì— í•´ë‹¹í•˜ëŠ” ë¡œê·¸
            - PIDëŠ” 108000ì´ê³  state=Emptyì´ë©° topicPartitions=Set()ì—ë„ ì•„ë¬´ ê°’ì´ ì—†ë‹¤.
        2. ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ ìƒíƒœ í‘œì‹œ ë° ë©”ì‹œì§€ ì „ì†¡ì— í•´ë‹¹í•˜ëŠ” ë¡œê·¸ ë‚´ìš©
            - state=Ongoingìœ¼ë¡œ ë³€ê²½ëê³ , ì´ë¥¼ í†µí•´ í•´ë‹¹ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.
            - topicPartitions=Set(peter-test05-0)ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì–´ peter-test05 í† í”½ì˜ 0ë²ˆ íŒŒí‹°ì…˜ì— íŠ¸ëœì­ì…˜ì´ ì§„í–‰ë˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.
        3. ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ íŠ¸ëœì­ì…˜ ì¢…ë£Œ ìš”ì²­ì— í•´ë‹¹í•˜ëŠ” ë¡œê·¸ ë‚´ìš©
            - state=PrepareCommitìœ¼ë¡œ ë³€ê²½ëë‹¤.
            - íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œëŠ” peter-test05 í† í”½ì˜ 0ë²ˆ íŒŒí‹°ì…˜ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ì„ ì™„ë£Œí–ˆìœ¼ë©°, íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ì— íŠ¸ëœì­ì…˜ ì¢…ë£Œ ìš”ì²­ì„ ë³´ë‚¸ ìƒíƒœ
            - íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ë‘ ë‹¨ê³„ ì»¤ë°‹ ê³¼ì • ì¤‘ 1ë‹¨ê³„ ì»¤ë°‹ê¹Œì§€ ì™„ë£Œí•œ ìƒíƒœ
        4. ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ ë§ˆì§€ë§‰ì¸ íŠ¸ëœì­ì…˜ ì™„ë£Œì— í•´ë‹¹í•˜ëŠ” ë‚´ìš©
            - state=CompleteCommitìœ¼ë¡œ ë³€ê²½ëê³ , íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œê°€ peter-test05 í† í”½ìœ¼ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ ë‹¨ê³„ê°€ ìµœì¢…ì ìœ¼ë¡œ ì™„ë£ŒëìŒ
            - íŠ¸ëœì­ì…˜ ì½”ë””ë„¤ì´í„°ëŠ” ë‘ ë‹¨ê³„ ì»¤ë°‹ ê³¼ì • ì¤‘ 2ë‹¨ê³„ ì»¤ë°‹ê¹Œì§€ ì™„ë£Œí•œ ìƒíƒœ
    - peter-test05 í† í”½ì˜ ë¡œê·¸ íŒŒì¼ ğŸ‘‰Â ì¶”ê°€ëœ ì˜¤í”„ì…‹ ë¶€ë¶„ì´ ë°”ë¡œ, ì•ì„œ ì„¤ëª…í•œ ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ ì‚¬ìš©ì í† í”½ì— íŠ¸ëœì­ì…˜ ì™„ë£Œ ìœ ë¬´ í‘œì‹œì™€ ê´€ë ¨ëœ ë‚´ìš©
        
        ```bash
        root@kafka1:/# kafka-dump-log --print-data-log --files /var/lib/kafka/data/peter-test05-0/00000000000000000000.log
        # 1
        baseOffset: 1 lastOffset: 1 count: 1 baseSequence: 0 lastSequence: 0 producerId: 108000 producerEpoch: 2 partitionLeaderEpoch: 5 isTransactional: true isControl: false position: 78 CreateTime: 1663504274237 size: 120 magic: 2 compresscodec: NONE crc: 929661091 isvalid: true
        | offset: 1 CreateTime: 1663504274237 keysize: -1 valuesize: 52 sequence: 0 headerKeys: [] payload: Apache Kafka is a distributed streaming platform - 0
        # 2
        baseOffset: 2 lastOffset: 2 count: 1 baseSequence: -1 lastSequence: -1 producerId: 108000 producerEpoch: 2 partitionLeaderEpoch: 5 isTransactional: true isControl: true position: 198 CreateTime: 1663504274507 size: 78 magic: 2 compresscodec: NONE crc: 3655409043 isvalid: true
        | offset: 2 CreateTime: 1663504274507 keysize: 4 valuesize: 6 sequence: -1 headerKeys: [] endTxnMarker: COMMIT coordinatorEpoch: 0
        ```
        
        1. íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œê°€ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œ ë‚´ìš©
            - ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ ë©”ì‹œì§€ ì „ì†¡ì— í•´ë‹¹í•˜ëŠ” ë‚´ìš©
            - ì¡°ê¸ˆ ì „ íŠ¸ëœì­ì…˜ í† í”½ì—ì„œ í™•ì¸í–ˆë˜ PID 108000ì´ ë™ì¼
            - í”„ë¡œë“€ì„œ ì—í¬í¬ëŠ” 2, ì‹œí€€ìŠ¤ ë²ˆí˜¸ëŠ” 0
            - `isTransactional: true`ë¼ëŠ” ë‚´ìš©ì„ í†µí•´ í•´ë‹¹ ë©”ì‹œì§€ê°€ íŠ¸ëœì­ì…˜ ë©”ì‹œì§€ì„ì„ íŒŒì•…í•  ìˆ˜ ìˆë‹¤.
        2. í•´ë‹¹ ì˜¤í”„ì…‹ì˜ ë©”ì‹œì§€ëŠ” ì¼ë°˜ì ì¸ í”„ë¡œë“€ì„œê°€ ë³´ë‚¸ ë©”ì‹œì§€ì™€ëŠ” ë‹¤ë¥¸ í˜•íƒœë¡œ ì €ì¥ë˜ì–´ ìˆë‹¤ â†’ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€
            - 1ë²ˆ ì˜¤í”„ì…‹ì˜ í˜ì´ë¡œë“œ(payload)ì™€ ë¹„êµí•´ë³´ë©´, í˜ì´ë¡œë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©° `endTxnMarker: COMMIT`ì´ë¼ëŠ” ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
            - ì •í™•íˆ í•œ ë²ˆ ë‹¨ê³„ë³„ ë™ì‘ ì¤‘ ì‚¬ìš©ì í† í”½ì— íŠ¸ëœì­ì…˜ ì™„ë£Œ ìœ ë¬´ í‘œì‹œì™€ ê´€ë ¨ëœ ë‚´ìš©
            - íŠ¸ëœì­ì…˜ ì»¨ìŠˆë¨¸ì˜ ê²½ìš° í•´ë‹¹ ë©”ì‹œì§€ê°€ ìˆì–´ì•¼ë§Œ ì•ì˜ ë©”ì‹œì§€ë¥¼ ì½ì„ ìˆ˜ ìˆë‹¤.

- ì°¸ê³ 
    - [https://github.com/bingbingpa/dev-book/blob/master/kafka-dev-to-operation/ch05.md](https://github.com/bingbingpa/dev-book/blob/master/kafka-dev-to-operation/ch05.md)
    - [https://velog.io/@fj2008/í”„ë¡œë“€ì„œ-ë‚´ë¶€ë™ì‘ì›ë¦¬](https://velog.io/@fj2008/%ED%94%84%EB%A1%9C%EB%93%80%EC%84%9C-%EB%82%B4%EB%B6%80%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC)

# Chapter 21. 몽고DB 시작과 중지

## 1. 명령행에서 시작하기

---

- 몽고DB 서버는 `mongod` 실행 파일로 시작한다.
    - `—-dbpath`
        - 데이터 디렉토리로 사용할 경로를 지정한다.
        - 기본값은 `/data/db`
        - 하나의 서버 내 `mongod` 프로세스들은 각각 별도 데이터 디렉터리를 사용한다.
            - `mongod`가 시작되면 다른 mongod 프로세스가 해당 데이터 디렉터리를 사용하지 못하도록 데이터 디렉터리에 `mongod.lock` 파일을 생성한다.
    - `—-port`
        - 서버가 연결을 대기할 포트 번호를 지정한다.
        - 기본적으로 `mongod`는 27017번 포트를 사용
    - `--fork`
        - 유닉스 기반 시스템에서는 서버 프로세스를 포크(생성)해서 몽고DB를 데몬으로 작동시킨다
        - `--fork`를 명시할 때는 `--logpath`를 사용해야 한다.
    - `--logpath`
        - 모든 출력을 명령행에 표시하지 않고 지정한 파일로 출력한다.
        - 만약 파일이 존재하지 않으면 새로 생성하는데, 이때 해당 디렉터리에 대한 쓰기 권한이 있어야 한다.
        - 이미 로그 파일이 존재하면 덮어쓰기를 한다.
            - 예전 로그를 지우지 않고 남기려면 `--logpath`와 함께 `—-logappend` 옵션을 사용한다.(강력 추천)
    - `—-directoryperdb`
        - 각 데이터베이스를 자신의 디렉터리에 저장한다.
    - `—-config`
        - 명령행에서 지정하지 않은 옵션을 추가하는 용도의 구성 파일을 사용한다.

- 데이터베이스를 시작하면 몽고DB는 몽고DB의 버전, 기반 시스템, 사용된 플래그를 설명하는 `local.startup_log` 컬렉션에 도큐먼트를 쓴다.
    - `mongo` 셸을 사용해 도큐먼트를 볼 수 있다.
    - 이 컬렉션은 업그레이드와 변화를 추적하는 데 용이하다.

### 1-1. 파일 기반 구성

---

- 몽고DB는 파일로부터 구성 정보를 읽어들이는 기능을 지원한다.
    - `-f`나 `—-config` 플래그를 사용한다.
        - ex> `mongod —-config ~/.mongodb.conf`
    - 몽고DB 2.6부터 몽고DB 구성 파일은 YAML 형식을 사용한다.

## 2. 몽고DB 중지하기

---

- `shutdown` 명령 `{"shutdown": 1}`: 관리자 명령이며 `admin` 데이터베이스에서 실행해야 한다.
    
    ```bash
    > use admin
    > db.shutdownServer()
    server should be down...
    ```
    
    - 프라이머리에서 실행 중일 때, `shutdown` 명령은 서버가 중지하기 전에 프라이머리를 강등한 후 세컨더리가 따라잡도록 대기한다.
        - 롤백 가능성을 최소화하지만 중지 성공을 보장하지는 않는다.
        - `force` 옵션을 사용하면 프라이머리를 중지시키도록 `shutdown` 명령을 강제할 수 있다.
            
            ```bash
            > db.adminCommand({"shutdown": 1, "force": true})
            ```
            

- `SIGNIT` 또는 `SIGTERM` 시그널을 보내는 것과 동일하다.
    - 서버가 터미널에서 포그라운드 프로세스로 실행 중이면 `SIGNIT`는 Ctrl+C로 보낼 수 있다.
    - 혹은 `kill` 명령으로 해당 시그널을 보낼 수 있다.
        - ex> `mongod`의 PID가 10014라면,
            - `kill -2 10014` (`SIGNIT`)
            - `kill 10014` (`SIGTERM`)

- `mongod`는 `SIGNIT`이나 `SIGTERM`을 받으면 안전하게 종료된다
    - 현재 실행 중인 작업이나 파일 사전 할당이 종료할 때까지 대기했다가 모든 연결을 닫고, 메모리에 남아 있는 데이터를 디스크에 쓴 후 종료한다.

## 3. 보안

---

- 몽고DB 서버를 공개적으로 접근할 수 있게 설정하지 말자. 몽고DB와 외부 환경 사이의 연결은 가능한 한 엄격히 제한해야 한다.
    - 가장 좋은 방법은 방화벽을 구성하고 오직 몽고DB만 내부 네트워크 주소에 도달할 수 있게 하는 방법이다.

- 구성 파일에 옵션을 추가해 방화벽 이상으로 보안을 강화할 수 있다.
    - `—-bind_ip`
        - 몽고DB를 연결할 인터페이스를 지정한다. 일반적으로 내부 IP로 지정한다.
            - 같은 장비에서 애플리케이션 서버를 실행 중이라면 `mongos` 프로세스를 `localhost`로 사용해도 상관없다.
            - 구성 서버나 샤드는 다른 서버가 접근할 수 있어야 하므로 `localhost`가 아닌 주소를 지정하자.
        - 몽고DB 3.6부터 `mongod`와 `mongos` 프로세스는 기본적으로 `localhost`에 바인딩된다.
            - 다른 주소에 바인딩하려면 `net.bindIp` 구성 파일 설정이나 `—-bind_ip` 명령행 옵션을 사용해 호스트명이나 IP 주소의 목록을 지정한다.
    - `nounixsocket`
        - 유닉스 도메인 소켓에서 수신(listening)을 비활성화한다.
    - `--noscripting`
        - 서버 측 자바스크립트 코드가 실행되지 않도록 한다.
            - 일반적으로 허용하지 않는 편이 안전하다.
        - 몇몇 셸 보조자, 특히 `sh.status()`는 서버에서 자바스크립트 사용이 가능하다고 가정한다.
            - 비활성화된 상태에서 이러한 셸 보조자를 실행하면 오류가 발생한다.

### 3-1. 데이터 암호화

---

- 데이터 암호화는 몽고DB 엔터프라이즈에서 사용할 수 있다.

- 데이터 암호화 프로세스
    - 마스터 키를 생성한다.
    - 각 데이터베이스에 대한 키를 생성한다.
    - 데이터베이스 키로 데이터를 암호화한다.
    - 마스터 키로 데이터베이스 키를 암호화한다.

- 데이터 암호화를 사용하면 모든 데이터 파일이 파일시스템에서 암호화된다.
    - 데이터는 메모리에 있을 때와 전송 중에만 비암호화 된다.
    - 몽고DB의 모든 네트워크 트래픽을 암호화하려면 TLS/SSL을 사용한다.

- 데이터 암호화 옵션을 구성 파일에 추가할 수 있다.
    - `—-enableEncryption`
        - 와이어드타이거 스토리지 엔진에서 암호화를 활성화한다.
        - 메모리와 디스크에 저장된 데이터가 암호화된다. '미사용 암호화'라고도 한다.
        - 암호화 키를 전달하고 암호화를 구성하려면 옵션을 `true`로 설정해야 한다. 기본값은 `false`다.
    - `—-encryptionCipherMode`
        - 와이어드타이거에서 미사용 암호화를 위한 암호 모드를 설정한다.
            - `AES256-CBC`와 `AES256-GCM`이라는 두 가지 모드를 사용할 수 있다.
            - 몽고DB 4.0부터 윈도우상에서 몽고DB 엔터프라이즈는 `AES256-GCM`을 더는 지원하지 않는다.
    - `—-encryptionKeyFile`
        - 키 관리 상호운용성 프로토콜(KMIP) 이외의 프로세스를 사용해 키를 관리하는 경우 로컬 키파일의 경로를 지정하자.
- 몽고DB 엔터프라이즈는 KMIP를 사용한 키 관리도 지원한다.

### 3-2. SSL 연결

---

- 몽고DB는 TLS/SSL을 사용한 전송 암호화를 지원한다.
    - 몽고DB 커뮤니티 버전과 엔터프라이즈 버전 둘 다 이 기능을 사용할 수 있다.
    - 몽고DB는 운영체제에서 사용할 수 있는 네이티브 TLS/SSL 라이브러리를 사용한다.
    - `—-tlsMode` 옵션 및 관련된 옵션을 사용해 TLS/SSL을 구성하자.

## 4. 로깅

---

- 몽고DB는 다량의 로그 메시지를 발생시키지만, 그럼에도 `—-quiet` 옵션으로 실행하지 않아야 한다.
    - 로그 레벨을 기본 수준으로 놔두는 것은 적합하다.

- 애플리케이션에서 특정 문제를 디버깅하고 있다면 옵션을 사용해 로그로부터 더 많은 정보를 얻을 수 있다.
    - `setParameter` 명령을 실행하거나, 시작 시 `—-setParameter` 옵션을 사용해 로그 레벨을 문자열로 전달함으로써 로그 레벨을 변경한다.
        
        ```bash
        > db.adminCommand({"setParameter": 1, "logLevel": 3})
        ```
        
- 특정 구성 요소에 대한 로그 레벨도 변경할 수 있다.
    - ex> 기본 로그 상세 수준을 1로 설정하고, 쿼리 구성 요소 상세 수준을 2로 설정
        
        ```bash
        > db.adminCommand({"setParameter": 1, logComponentVerbosity: 
             { verbosity: 1, query: { verbosity: 2 }}})
        ```
        
- 디버깅이 완료되면 로그 레벨을 0으로 되돌리는 것을 잊지 말자.
    - 로그 레벨은 5까지 설정할 수 있다.

- 기본적으로 몽고DB는 실행 시간이 100밀리초 이상인 쿼리 정보를 로그에 남긴다.
    - `setProfilingLevel`: 임계치를 바꿈
        
        ```bash
        // 500밀리초를 초과하는 쿼리만 로그에 남긴다.
        > db.setProfilingLevel(1, 500)
        { "was": 0, "slowms": 100, "ok": 1 }
        > db.setProfilingLevel(0)
        { "was": 1, "slowms": 500, "ok": 1 }
        ```
        
        - 이 매개변수는 몽고DB를 `—-slowms` 옵션으로 재시작함으로써 설정할 수 있다.

- 매일 혹은 매주 로그를 순환하는 `cron` 작업을 설정할 수 있다.
    - 몽고DB가 `--logpath` 옵션으로 시작했으면 프로세스에 `SIGUSR1` 신호를 보내 로그를 주기적으로 순환할 수 있다.
    - `logRotate` 명령도 같은 작업을 수행한다.
        
        ```bash
        > db.adminCommand({"logRotate": 1})
        ```
        
    - 몽고DB를 `--logpath` 옵션으로 시작하지 않았으면 로그를 순환할 수 없다.